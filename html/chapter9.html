<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬9ç« ï¼šæ¨èç³»ç»Ÿä¸ç®—æ³•</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Bç«™æŠ€æœ¯å‘å±•å²ï¼šä»å¼¹å¹•ç½‘ç«™åˆ°ç»¼åˆæ€§å†…å®¹å¹³å°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šåˆ›ä¸–çºªï¼ˆ2009-2011ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šæˆé•¿æœŸï¼ˆ2012-2014ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šç§»åŠ¨è½¬å‹ï¼ˆ2015-2017ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè§„æ¨¡åŒ–æ‰©å¼ ï¼ˆ2018-2020ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šæŠ€æœ¯æ·±è€•ï¼ˆ2021-2023ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šAIæ—¶ä»£ï¼ˆ2024-è‡³ä»Šï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå¼¹å¹•ç³»ç»Ÿæ¼”è¿›å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè§†é¢‘æŠ€æœ¯æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šæ¨èç³»ç»Ÿä¸ç®—æ³•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šç›´æ’­æŠ€æœ¯ä½“ç³»</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šåŸºç¡€è®¾æ–½å»ºè®¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šæŠ€æœ¯ç»„ç»‡ä¸æ–‡åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="9">ç¬¬9ç« ï¼šæ¨èç³»ç»Ÿä¸ç®—æ³•</h1>
<blockquote>
<p>ä»äººå·¥ç¼–è¾‘åˆ°AIé©±åŠ¨ï¼ŒBç«™æ¨èç³»ç»Ÿçš„æŠ€æœ¯æ¼”è¿›ä¹‹è·¯</p>
</blockquote>
<h2 id="_1">ç« èŠ‚æ¦‚è§ˆ</h2>
<p>Bç«™çš„æ¨èç³»ç»Ÿç»å†äº†ä»çº¯äººå·¥è¿è¥åˆ°æ™ºèƒ½ç®—æ³•çš„å®Œæ•´è¿›åŒ–å†ç¨‹ã€‚ä½œä¸ºä¸€ä¸ªä»¥ç”¨æˆ·ç”Ÿæˆå†…å®¹ï¼ˆUGCï¼‰ä¸ºæ ¸å¿ƒçš„å¹³å°ï¼Œæ¨èç³»ç»Ÿä¸ä»…å†³å®šäº†å†…å®¹åˆ†å‘æ•ˆç‡ï¼Œæ›´ç›´æ¥å½±å“ç€åˆ›ä½œè€…ç”Ÿæ€å’Œç”¨æˆ·ä½“éªŒã€‚æœ¬ç« å°†æ·±å…¥å‰–æBç«™æ¨èç³»ç»Ÿçš„æŠ€æœ¯æ¶æ„ã€ç®—æ³•æ¼”è¿›å’Œå·¥ç¨‹å®è·µã€‚</p>
<h2 id="_2">ç›®å½•</h2>
<ol>
<li><a href="#ä»ç¼–è¾‘æ¨èåˆ°ç®—æ³•æ¨è">ä»ç¼–è¾‘æ¨èåˆ°ç®—æ³•æ¨è</a></li>
<li><a href="#ä¸ªæ€§åŒ–æ¨èæ¶æ„">ä¸ªæ€§åŒ–æ¨èæ¶æ„</a></li>
<li><a href="#æ·±åº¦å­¦ä¹ åº”ç”¨">æ·±åº¦å­¦ä¹ åº”ç”¨</a></li>
<li><a href="#ç”¨æˆ·ç”»åƒç³»ç»Ÿ">ç”¨æˆ·ç”»åƒç³»ç»Ÿ</a></li>
<li><a href="#abæµ‹è¯•å¹³å°">ABæµ‹è¯•å¹³å°</a></li>
</ol>
<hr />
<h2 id="_3">ä»ç¼–è¾‘æ¨èåˆ°ç®—æ³•æ¨è</h2>
<h3 id="11-2009-2013">1.1 äººå·¥ç¼–è¾‘æ—¶ä»£ï¼ˆ2009-2013ï¼‰</h3>
<h4 id="_4">è¿è¥æœºåˆ¶</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ—©æœŸæ¨èæµç¨‹ï¼ˆ2009-2013ï¼‰         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  UPä¸»ä¸Šä¼  â†’ å®¡æ ¸å‘˜å®¡æ ¸ â†’ ç¼–è¾‘ç²¾é€‰       â”‚
â”‚     â†“           â†“            â†“          â”‚
â”‚  æ™®é€šåŒºåŸŸ    é€šè¿‡/æ‹’ç»    é¦–é¡µæ¨è      â”‚
â”‚                                          â”‚
â”‚  æ¨èä½ï¼š                                â”‚
â”‚  - é¦–é¡µBannerï¼ˆ3-5ä¸ªï¼‰                   â”‚
â”‚  - åˆ†åŒºæ¨èï¼ˆæ¯åŒº5-10ä¸ªï¼‰                â”‚
â”‚  - æ¯æ—¥ç²¾é€‰ï¼ˆ10-20ä¸ªï¼‰                   â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="_5">ç¼–è¾‘å›¢é˜Ÿæ„æˆ</h4>
<p>| æ—¶æœŸ | å›¢é˜Ÿè§„æ¨¡ | æ—¥å¤„ç†è§†é¢‘é‡ | æ¨èå‡†ç¡®ç‡ |</p>
<table>
<thead>
<tr>
<th>æ—¶æœŸ</th>
<th>å›¢é˜Ÿè§„æ¨¡</th>
<th>æ—¥å¤„ç†è§†é¢‘é‡</th>
<th>æ¨èå‡†ç¡®ç‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>2009</td>
<td>2-3äºº</td>
<td>50-100</td>
<td>ä¾èµ–ä¸ªäººå“å‘³</td>
</tr>
<tr>
<td>2010</td>
<td>5-8äºº</td>
<td>200-300</td>
<td>~40%</td>
</tr>
<tr>
<td>2011</td>
<td>10-15äºº</td>
<td>500-800</td>
<td>~45%</td>
</tr>
<tr>
<td>2012</td>
<td>20-30äºº</td>
<td>1000-1500</td>
<td>~50%</td>
</tr>
<tr>
<td>2013</td>
<td>30-50äºº</td>
<td>2000-3000</td>
<td>~55%</td>
</tr>
</tbody>
</table>
<h4 id="_6">é—®é¢˜ä¸æŒ‘æˆ˜</h4>
<ul>
<li><strong>æ‰©å±•æ€§å·®</strong>ï¼šäººå·¥æˆæœ¬éšå†…å®¹é‡çº¿æ€§å¢é•¿</li>
<li><strong>æ—¶æ•ˆæ€§ä½</strong>ï¼šçƒ­ç‚¹å†…å®¹å‘ç°å»¶è¿Ÿï¼ˆå¹³å‡6-12å°æ—¶ï¼‰</li>
<li><strong>ä¸ªæ€§åŒ–ç¼ºå¤±</strong>ï¼šåƒäººä¸€é¢çš„æ¨èç»“æœ</li>
<li><strong>ä¸»è§‚åè§</strong>ï¼šç¼–è¾‘ä¸ªäººå–œå¥½å½±å“æ¨èå…¬å¹³æ€§</li>
</ul>
<h3 id="12-2014-2016">1.2 ç®—æ³•æ¢ç´¢æœŸï¼ˆ2014-2016ï¼‰</h3>
<h4 id="_7">ååŒè¿‡æ»¤åˆæ¢</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ—©æœŸååŒè¿‡æ»¤ä¼ªä»£ç ç¤ºä¾‹</span>
<span class="k">class</span> <span class="nc">SimpleCollaborativeFilter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_item_matrix</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ç”¨æˆ·-è§†é¢‘äº¤äº’çŸ©é˜µ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_cache</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># ç›¸ä¼¼åº¦ç¼“å­˜</span>

    <span class="k">def</span> <span class="nf">calculate_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user1</span><span class="p">,</span> <span class="n">user2</span><span class="p">):</span>
        <span class="c1"># åŸºäºä½™å¼¦ç›¸ä¼¼åº¦</span>
        <span class="n">common_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_item_matrix</span><span class="p">[</span><span class="n">user1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> \
                      <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_item_matrix</span><span class="p">[</span><span class="n">user2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">common_items</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># ç®€åŒ–çš„ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">user_item_matrix</span><span class="p">[</span><span class="n">user1</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">*</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">user_item_matrix</span><span class="p">[</span><span class="n">user2</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">common_items</span><span class="p">])</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_item_matrix</span><span class="p">[</span><span class="n">user1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span> <span class="o">*</span> \
                     <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_item_matrix</span><span class="p">[</span><span class="n">user2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>

        <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span> <span class="k">if</span> <span class="n">denominator</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</code></pre></div>

<h4 id="_8">æ··åˆæ¨èç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ··åˆæ¨èæ¶æ„ï¼ˆ2014-2016ï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚   çƒ­é—¨æ¨èï¼ˆ30%ï¼‰                           â”‚
â”‚      â”œâ”€â”€ æ’­æ”¾é‡æ’åº                        â”‚
â”‚      â”œâ”€â”€ å¼¹å¹•æ•°æ’åº                        â”‚
â”‚      â””â”€â”€ ç¡¬å¸æ•°æ’åº                        â”‚
â”‚                                             â”‚
â”‚   ååŒè¿‡æ»¤ï¼ˆ40%ï¼‰                           â”‚
â”‚      â”œâ”€â”€ User-Based CF                     â”‚
â”‚      â”œâ”€â”€ Item-Based CF                     â”‚
â”‚      â””â”€â”€ Matrix Factorization              â”‚
â”‚                                             â”‚
â”‚   ç¼–è¾‘æ¨èï¼ˆ20%ï¼‰                           â”‚
â”‚      â””â”€â”€ äººå·¥ç²¾é€‰å†…å®¹                      â”‚
â”‚                                             â”‚
â”‚   éšæœºæ¢ç´¢ï¼ˆ10%ï¼‰                           â”‚
â”‚      â””â”€â”€ æ–°å†…å®¹æ›å…‰                        â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="13-2017-2019">1.3 æœºå™¨å­¦ä¹ æ—¶ä»£ï¼ˆ2017-2019ï¼‰</h3>
<h4 id="_9">ç‰¹å¾å·¥ç¨‹ä½“ç³»</h4>
<p>| ç‰¹å¾ç±»åˆ« | å…·ä½“ç‰¹å¾ | ç»´åº¦ | é‡è¦æ€§ |</p>
<table>
<thead>
<tr>
<th>ç‰¹å¾ç±»åˆ«</th>
<th>å…·ä½“ç‰¹å¾</th>
<th>ç»´åº¦</th>
<th>é‡è¦æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç”¨æˆ·ç‰¹å¾</td>
<td>å¹´é¾„ã€æ€§åˆ«ã€åœ°åŸŸã€è®¾å¤‡</td>
<td>~50</td>
<td>é«˜</td>
</tr>
<tr>
<td>è§†é¢‘ç‰¹å¾</td>
<td>æ ‡é¢˜ã€æ ‡ç­¾ã€æ—¶é•¿ã€åˆ†åŒº</td>
<td>~200</td>
<td>é«˜</td>
</tr>
<tr>
<td>ç»Ÿè®¡ç‰¹å¾</td>
<td>CTRã€å®Œæ’­ç‡ã€äº’åŠ¨ç‡</td>
<td>~100</td>
<td>æé«˜</td>
</tr>
<tr>
<td>æ—¶é—´ç‰¹å¾</td>
<td>å‘å¸ƒæ—¶é—´ã€è§‚çœ‹æ—¶é—´ã€èŠ‚å‡æ—¥</td>
<td>~30</td>
<td>ä¸­</td>
</tr>
<tr>
<td>åˆ›ä½œè€…ç‰¹å¾</td>
<td>ç²‰ä¸æ•°ã€æ›´æ–°é¢‘ç‡ã€å†…å®¹è´¨é‡</td>
<td>~50</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<h4 id="_10">æ’åºæ¨¡å‹æ¼”è¿›</h4>
<div class="codehilite"><pre><span></span><code><span class="mi">2017</span><span class="o">:</span><span class="w"> </span><span class="n">Logistic</span><span class="w"> </span><span class="n">Regression</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="mi">2018</span><span class="o">:</span><span class="w"> </span><span class="n">GBDT</span><span class="w"> </span><span class="o">(</span><span class="n">Gradient</span><span class="w"> </span><span class="n">Boosting</span><span class="w"> </span><span class="n">Decision</span><span class="w"> </span><span class="n">Tree</span><span class="o">)</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="mi">2019</span><span class="o">:</span><span class="w"> </span><span class="n">Wide</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Deep</span><span class="w"> </span><span class="n">Model</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="w">     </span><span class="err">ç‰¹å¾äº¤å‰</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">æ·±åº¦å­¦ä¹ </span>
</code></pre></div>

<h3 id="14-2020-">1.4 æ·±åº¦å­¦ä¹ é©å‘½ï¼ˆ2020-è‡³ä»Šï¼‰</h3>
<h4 id="_11">æ¨¡å‹æ¶æ„å‡çº§</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ·±åº¦æ¨èæ¨¡å‹æ¶æ„ï¼ˆ2020+ï¼‰            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  å¬å›å±‚ï¼ˆRecallï¼‰                            â”‚
â”‚   â”œâ”€â”€ ååŒè¿‡æ»¤å¬å›                          â”‚
â”‚   â”œâ”€â”€ å†…å®¹å¬å›ï¼ˆBERTï¼‰                      â”‚
â”‚   â”œâ”€â”€ å›¾ç¥ç»ç½‘ç»œå¬å›                        â”‚
â”‚   â””â”€â”€ å®æ—¶çƒ­ç‚¹å¬å›                          â”‚
â”‚                    â†“                         â”‚
â”‚  ç²—æ’å±‚ï¼ˆPre-rankingï¼‰                       â”‚
â”‚   â””â”€â”€ è½»é‡çº§DNNï¼ˆ~1000å€™é€‰ï¼‰                â”‚
â”‚                    â†“                         â”‚
â”‚  ç²¾æ’å±‚ï¼ˆRankingï¼‰                           â”‚
â”‚   â””â”€â”€ å¤æ‚DNNæ¨¡å‹ï¼ˆ~100å€™é€‰ï¼‰               â”‚
â”‚                    â†“                         â”‚
â”‚  é‡æ’å±‚ï¼ˆRe-rankingï¼‰                        â”‚
â”‚   â”œâ”€â”€ å¤šæ ·æ€§ä¼˜åŒ–                            â”‚
â”‚   â”œâ”€â”€ ä¸šåŠ¡è§„åˆ™                              â”‚
â”‚   â””â”€â”€ ç”¨æˆ·ä½“éªŒä¼˜åŒ–                          â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="_12">ç”¨æˆ·ç”»åƒç³»ç»Ÿ</h2>
<h3 id="41">4.1 ç”»åƒä½“ç³»æ¶æ„</h3>
<h4 id="_13">å¤šå±‚æ¬¡ç”¨æˆ·ç”»åƒ</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Bç«™ç”¨æˆ·ç”»åƒä½“ç³»                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  åŸºç¡€å±æ€§å±‚                                  â”‚
â”‚   â”œâ”€â”€ äººå£ç»Ÿè®¡ï¼šå¹´é¾„ã€æ€§åˆ«ã€åœ°åŸŸ            â”‚
â”‚   â”œâ”€â”€ è®¾å¤‡ä¿¡æ¯ï¼šæœºå‹ã€ç³»ç»Ÿã€ç½‘ç»œ            â”‚
â”‚   â””â”€â”€ è´¦å·ä¿¡æ¯ï¼šç­‰çº§ã€å¤§ä¼šå‘˜ã€æ³¨å†Œæ—¶é—´      â”‚
â”‚                                              â”‚
â”‚  è¡Œä¸ºç‰¹å¾å±‚                                  â”‚
â”‚   â”œâ”€â”€ è§‚çœ‹è¡Œä¸ºï¼šæ—¶é•¿ã€é¢‘æ¬¡ã€å®Œæ’­ç‡          â”‚
â”‚   â”œâ”€â”€ äº’åŠ¨è¡Œä¸ºï¼šç‚¹èµã€æŠ•å¸ã€æ”¶è—ã€å¼¹å¹•      â”‚
â”‚   â”œâ”€â”€ ç¤¾äº¤è¡Œä¸ºï¼šå…³æ³¨ã€ç§ä¿¡ã€åŠ¨æ€            â”‚
â”‚   â””â”€â”€ åˆ›ä½œè¡Œä¸ºï¼šæŠ•ç¨¿ã€ç›´æ’­ã€ä¸“æ             â”‚
â”‚                                              â”‚
â”‚  å…´è¶£æ ‡ç­¾å±‚                                  â”‚
â”‚   â”œâ”€â”€ å†…å®¹åå¥½ï¼šåˆ†åŒºã€æ ‡ç­¾ã€UPä¸»            â”‚
â”‚   â”œâ”€â”€ æ—¶é—´åå¥½ï¼šæ´»è·ƒæ—¶æ®µã€è§‚çœ‹èŠ‚å¥          â”‚
â”‚   â””â”€â”€ æ¶ˆè´¹åå¥½ï¼šä»˜è´¹æ„æ„¿ã€æ‰“èµä¹ æƒ¯          â”‚
â”‚                                              â”‚
â”‚  ä»·å€¼åˆ†å±‚                                    â”‚
â”‚   â”œâ”€â”€ ç”¨æˆ·ä»·å€¼ï¼šLTVã€æ´»è·ƒåº¦ã€ç•™å­˜          â”‚
â”‚   â”œâ”€â”€ å†…å®¹ä»·å€¼ï¼šå†…å®¹æ¶ˆè´¹é‡ã€è´¨é‡åå¥½        â”‚
â”‚   â””â”€â”€ ç¤¾åŒºä»·å€¼ï¼šUGCè´¡çŒ®ã€ç¤¾äº¤å½±å“åŠ›         â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="42">4.2 æ ‡ç­¾ä½“ç³»å»ºè®¾</h3>
<h4 id="_14">æ ‡ç­¾åˆ†ç±»æ¶æ„</h4>
<p>| æ ‡ç­¾ç±»å‹ | æ•°é‡çº§ | æ›´æ–°é¢‘ç‡ | åº”ç”¨åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th>æ ‡ç­¾ç±»å‹</th>
<th>æ•°é‡çº§</th>
<th>æ›´æ–°é¢‘ç‡</th>
<th>åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŸºç¡€æ ‡ç­¾</td>
<td>100+</td>
<td>æ¯å¤©</td>
<td>ç”¨æˆ·åˆ†ç¾¤</td>
</tr>
<tr>
<td>å…´è¶£æ ‡ç­¾</td>
<td>5000+</td>
<td>å®æ—¶</td>
<td>å†…å®¹æ¨è</td>
</tr>
<tr>
<td>è¡Œä¸ºæ ‡ç­¾</td>
<td>1000+</td>
<td>æ¯å°æ—¶</td>
<td>è¡Œä¸ºé¢„æµ‹</td>
</tr>
<tr>
<td>é¢„æµ‹æ ‡ç­¾</td>
<td>500+</td>
<td>æ¯å¤©</td>
<td>æµå¤±é¢„è­¦</td>
</tr>
<tr>
<td>åœˆå±‚æ ‡ç­¾</td>
<td>200+</td>
<td>æ¯å‘¨</td>
<td>ç¤¾ç¾¤è¿è¥</td>
</tr>
</tbody>
</table>
<h4 id="pipeline">æ ‡ç­¾ç”ŸæˆPipeline</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TagGenerationPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç”¨æˆ·æ ‡ç­¾ç”Ÿæˆæµæ°´çº¿&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_engine</span> <span class="o">=</span> <span class="n">RuleEngine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_storage</span> <span class="o">=</span> <span class="n">TagStorage</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_interest_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆå…´è¶£æ ‡ç­¾&quot;&quot;&quot;</span>
        <span class="c1"># è·å–ç”¨æˆ·è¡Œä¸ºåºåˆ—</span>
        <span class="n">behaviors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_behaviors</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># å†…å®¹æ ‡ç­¾èšåˆ</span>
        <span class="n">content_tags</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="n">behaviors</span><span class="p">:</span>
            <span class="n">video_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_video_tags</span><span class="p">(</span><span class="n">behavior</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_weight</span><span class="p">(</span><span class="n">behavior</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">video_tags</span><span class="p">:</span>
                <span class="n">content_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="c1"># TF-IDFæ ‡å‡†åŒ–</span>
        <span class="n">user_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfidf_normalize</span><span class="p">(</span><span class="n">content_tags</span><span class="p">)</span>

        <span class="c1"># æ ‡ç­¾è¡°å‡ï¼ˆæ—¶é—´è¡°å‡å› å­ï¼‰</span>
        <span class="n">decayed_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_time_decay</span><span class="p">(</span><span class="n">user_tags</span><span class="p">)</span>

        <span class="c1"># é˜ˆå€¼è¿‡æ»¤</span>
        <span class="n">final_tags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tag</span><span class="p">:</span> <span class="n">score</span> 
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">decayed_tags</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.3</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">final_tags</span>

    <span class="k">def</span> <span class="nf">calculate_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">behavior</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—è¡Œä¸ºæƒé‡&quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="s1">&#39;coin&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s1">&#39;favorite&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s1">&#39;share&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="mf">2.5</span>
        <span class="p">}</span>

        <span class="c1"># å®Œæ’­ç‡åŠ æƒ</span>
        <span class="n">completion_rate</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">watch_time</span> <span class="o">/</span> <span class="n">behavior</span><span class="o">.</span><span class="n">video_duration</span>
        <span class="n">base_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">behavior</span><span class="o">.</span><span class="n">action_type</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">base_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">completion_rate</span><span class="p">)</span>
</code></pre></div>

<h3 id="43">4.3 ç”¨æˆ·åˆ†ç¾¤ç­–ç•¥</h3>
<h4 id="_15">æ ¸å¿ƒç”¨æˆ·åˆ†ç¾¤</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·åˆ†ç¾¤çŸ©é˜µ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  æ´»è·ƒåº¦ç»´åº¦                                  â”‚
â”‚   é«˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚      â”‚æ ¸å¿ƒç”¨æˆ·â”‚æ´»è·ƒç”¨æˆ·â”‚æ™®é€šç”¨æˆ·â”‚          â”‚
â”‚   ä¸­ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚      â”‚å¿ å®ç”¨æˆ·â”‚å¸¸è§„ç”¨æˆ·â”‚ä½é¢‘ç”¨æˆ·â”‚          â”‚
â”‚   ä½ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚      â”‚å›æµç”¨æˆ·â”‚æ²‰ç¡ç”¨æˆ·â”‚æµå¤±ç”¨æˆ·â”‚          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        é«˜      ä¸­      ä½                    â”‚
â”‚            ä»·å€¼åº¦ç»´åº¦                        â”‚
â”‚                                              â”‚
â”‚  åˆ†ç¾¤ç­–ç•¥                                    â”‚
â”‚   â€¢ æ ¸å¿ƒç”¨æˆ·ï¼šä¸“å±æƒç›Šã€ä¼˜å…ˆä½“éªŒ            â”‚
â”‚   â€¢ æ´»è·ƒç”¨æˆ·ï¼šå†…å®¹ç²¾æ¨ã€ç¤¾åŒºäº’åŠ¨            â”‚
â”‚   â€¢ æ²‰ç¡ç”¨æˆ·ï¼šå¬å›ç­–ç•¥ã€æ¿€åŠ±å”¤é†’            â”‚
â”‚   â€¢ æ–°ç”¨æˆ·ï¼šå¼•å¯¼æ•™è‚²ã€å…´è¶£æ¢ç´¢              â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="rfm">RFMæ¨¡å‹åº”ç”¨</h4>
<p>| ç»´åº¦ | å®šä¹‰ | è®¡ç®—æ–¹æ³• | åˆ†å±‚é˜ˆå€¼ |</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>å®šä¹‰</th>
<th>è®¡ç®—æ–¹æ³•</th>
<th>åˆ†å±‚é˜ˆå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>R(Recency)</td>
<td>æœ€è¿‘æ´»è·ƒ</td>
<td>è·ä»Šå¤©æ•°</td>
<td>1/3/7/30å¤©</td>
</tr>
<tr>
<td>F(Frequency)</td>
<td>æ´»è·ƒé¢‘æ¬¡</td>
<td>æœˆå‡æ´»è·ƒå¤©æ•°</td>
<td>1/5/15/25å¤©</td>
</tr>
<tr>
<td>M(Monetary)</td>
<td>æ¶ˆè´¹ä»·å€¼</td>
<td>æœˆå‡æ¶ˆè´¹é‡‘é¢</td>
<td>Â¥0/10/50/200</td>
</tr>
</tbody>
</table>
<h3 id="44">4.4 å®æ—¶ç”»åƒæ›´æ–°</h3>
<h4 id="_16">æµå¼è®¡ç®—æ¶æ„</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å®æ—¶ç”»åƒæ›´æ–°ç³»ç»Ÿ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  æ•°æ®æº                                      â”‚
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯åŸ‹ç‚¹ â†’ Kafka                    â”‚
â”‚   â”œâ”€â”€ æœåŠ¡ç«¯æ—¥å¿— â†’ Flume                    â”‚
â”‚   â””â”€â”€ æ•°æ®åº“Binlog â†’ Canal                  â”‚
â”‚                â†“                             â”‚
â”‚  å®æ—¶è®¡ç®—å±‚ï¼ˆFlinkï¼‰                         â”‚
â”‚   â”œâ”€â”€ äº‹ä»¶æ¸…æ´—ï¼šå»é‡ã€è¿‡æ»¤ã€æ ‡å‡†åŒ–          â”‚
â”‚   â”œâ”€â”€ ç‰¹å¾è®¡ç®—ï¼šæ»‘åŠ¨çª—å£èšåˆ                â”‚
â”‚   â””â”€â”€ æ ‡ç­¾æ›´æ–°ï¼šå¢é‡è®¡ç®—                    â”‚
â”‚                â†“                             â”‚
â”‚  å­˜å‚¨å±‚                                      â”‚
â”‚   â”œâ”€â”€ Redisï¼šçƒ­æ•°æ®ï¼ˆ1å¤©å†…ï¼‰                â”‚
â”‚   â”œâ”€â”€ HBaseï¼šæ¸©æ•°æ®ï¼ˆ30å¤©å†…ï¼‰               â”‚
â”‚   â””â”€â”€ Hiveï¼šå†·æ•°æ®ï¼ˆå†å²å½’æ¡£ï¼‰              â”‚
â”‚                â†“                             â”‚
â”‚  æœåŠ¡å±‚                                      â”‚
â”‚   â””â”€â”€ ç”»åƒæŸ¥è¯¢APIï¼ˆQPS: 100K+ï¼‰             â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="_17">ç”»åƒæ›´æ–°ç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ProfileUpdateStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç”»åƒæ›´æ–°ç­–ç•¥&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisCluster</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hbase</span> <span class="o">=</span> <span class="n">HBaseClient</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_realtime_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å®æ—¶ç”»åƒæ›´æ–°&quot;&quot;&quot;</span>
        <span class="c1"># çŸ­æœŸè¡Œä¸ºåºåˆ—æ›´æ–°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_behavior_sequence</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="c1"># å®æ—¶ç»Ÿè®¡æŒ‡æ ‡æ›´æ–°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_statistics</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="c1"># å…´è¶£æ ‡ç­¾å¢é‡æ›´æ–°</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;favorite&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_interest_tags</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="c1"># è§¦å‘è§„åˆ™å¼•æ“</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_rules</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_behavior_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ›´æ–°è¡Œä¸ºåºåˆ—ï¼ˆä¿ç•™æœ€è¿‘1000æ¡ï¼‰&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user:behavior:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># ä½¿ç”¨Redis Listå­˜å‚¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">ltrim</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>  <span class="c1"># 1å¤©è¿‡æœŸ</span>

    <span class="k">def</span> <span class="nf">merge_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤šæ—¶é—´å°ºåº¦ç”»åƒèåˆ&quot;&quot;&quot;</span>
        <span class="c1"># å®æ—¶ç”»åƒï¼ˆ5åˆ†é’Ÿï¼‰</span>
        <span class="n">realtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_realtime_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># è¿‘æœŸç”»åƒï¼ˆ1å¤©ï¼‰</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># é•¿æœŸç”»åƒï¼ˆ30å¤©ï¼‰</span>
        <span class="n">longterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longterm_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># åŠ æƒèåˆ</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;interests&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_interests</span><span class="p">(</span>
                <span class="n">realtime</span><span class="o">.</span><span class="n">interests</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">recent</span><span class="o">.</span><span class="n">interests</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="n">longterm</span><span class="o">.</span><span class="n">interests</span> <span class="o">*</span> <span class="mf">0.2</span>
            <span class="p">),</span>
            <span class="s1">&#39;behaviors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_behaviors</span><span class="p">(</span>
                <span class="n">realtime</span><span class="p">,</span> <span class="n">recent</span><span class="p">,</span> <span class="n">longterm</span>
            <span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">merged</span>
</code></pre></div>

<h3 id="45">4.5 ç”»åƒåº”ç”¨åœºæ™¯</h3>
<h4 id="_18">ä¸ªæ€§åŒ–æ¨è</h4>
<div class="codehilite"><pre><span></span><code>ç”¨æˆ·ç”»åƒ â†’ å¬å›ç­–ç•¥
  â”œâ”€â”€ å…´è¶£æ ‡ç­¾ â†’ æ ‡ç­¾å¬å›
  â”œâ”€â”€ è¡Œä¸ºåºåˆ— â†’ ååŒè¿‡æ»¤
  â”œâ”€â”€ ç¤¾äº¤å…³ç³» â†’ ç¤¾äº¤æ¨è
  â””â”€â”€ æ¶ˆè´¹èƒ½åŠ› â†’ ä»˜è´¹å†…å®¹æ¨è
</code></pre></div>

<h4 id="_19">ç²¾å‡†è¥é”€</h4>
<p>| åœºæ™¯ | ç”»åƒç»´åº¦ | ç­–ç•¥ | æ•ˆæœ |</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>ç”»åƒç»´åº¦</th>
<th>ç­–ç•¥</th>
<th>æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ‹‰æ–°</td>
<td>ç›¸ä¼¼äººç¾¤</td>
<td>Look-alike</td>
<td>CTR +30%</td>
</tr>
<tr>
<td>ä¿ƒæ´»</td>
<td>æ²‰ç¡ç”¨æˆ·</td>
<td>Pushå¬å›</td>
<td>å”¤é†’ç‡ 15%</td>
</tr>
<tr>
<td>ä»˜è´¹è½¬åŒ–</td>
<td>ä»˜è´¹æ„æ„¿</td>
<td>å®šå‘ä¼˜æƒ </td>
<td>è½¬åŒ–ç‡ +50%</td>
</tr>
<tr>
<td>é˜²æµå¤±</td>
<td>æµå¤±é¢„è­¦</td>
<td>æŒ½ç•™ç­–ç•¥</td>
<td>ç•™å­˜ +20%</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_20">ä¸ªæ€§åŒ–æ¨èæ¶æ„</h2>
<h3 id="21">2.1 ç³»ç»Ÿæ•´ä½“æ¶æ„</h3>
<h4 id="_21">å››å±‚æ¶æ„è®¾è®¡</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Bç«™æ¨èç³»ç»Ÿæ¶æ„å…¨æ™¯                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  æ•°æ®å±‚ï¼ˆData Layerï¼‰                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·è¡Œä¸ºæ—¥å¿—ï¼ˆç‚¹å‡»ã€æ’­æ”¾ã€äº’åŠ¨ï¼‰        â”‚    â”‚
â”‚  â”‚ â€¢ å†…å®¹å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€æ ‡ç­¾ã€åˆ†ç±»ï¼‰          â”‚    â”‚
â”‚  â”‚ â€¢ å®æ—¶ç‰¹å¾ï¼ˆçƒ­åº¦ã€è¶‹åŠ¿ã€æ—¶æ•ˆï¼‰            â”‚    â”‚
â”‚  â”‚ â€¢ ç¦»çº¿ç‰¹å¾ï¼ˆç”¨æˆ·ç”»åƒã€å†…å®¹ç”»åƒï¼‰          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                           â”‚
â”‚  å¬å›å±‚ï¼ˆRecall Layerï¼‰                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ å¤šè·¯å¬å›ï¼šååŒ/å†…å®¹/çƒ­é—¨/æ ‡ç­¾/å…³æ³¨      â”‚    â”‚
â”‚  â”‚ â€¢ å€™é€‰é›†ï¼š10000+ â†’ 1000                   â”‚    â”‚
â”‚  â”‚ â€¢ å“åº”æ—¶é—´ï¼š&lt; 50ms                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                           â”‚
â”‚  æ’åºå±‚ï¼ˆRanking Layerï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ ç²—æ’ï¼š1000 â†’ 200ï¼ˆç®€å•æ¨¡å‹ï¼‰            â”‚    â”‚
â”‚  â”‚ â€¢ ç²¾æ’ï¼š200 â†’ 50ï¼ˆå¤æ‚æ¨¡å‹ï¼‰              â”‚    â”‚
â”‚  â”‚ â€¢ å“åº”æ—¶é—´ï¼š&lt; 100ms                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                           â”‚
â”‚  ç­–ç•¥å±‚ï¼ˆStrategy Layerï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ å¤šæ ·æ€§æ§åˆ¶                              â”‚    â”‚
â”‚  â”‚ â€¢ æ–°å†…å®¹æ‰¶æŒ                              â”‚    â”‚
â”‚  â”‚ â€¢ åˆ›ä½œè€…å¹³è¡¡                              â”‚    â”‚
â”‚  â”‚ â€¢ å•†ä¸šåŒ–æ··æ’                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="22">2.2 å¬å›ç­–ç•¥è¯¦è§£</h3>
<h4 id="_22">å¤šè·¯å¬å›æ¶æ„</h4>
<p>| å¬å›é€šé“ | ç®—æ³•ç±»å‹ | å¬å›é‡ | å»¶è¿Ÿ | æƒé‡ |</p>
<table>
<thead>
<tr>
<th>å¬å›é€šé“</th>
<th>ç®—æ³•ç±»å‹</th>
<th>å¬å›é‡</th>
<th>å»¶è¿Ÿ</th>
<th>æƒé‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>ååŒè¿‡æ»¤</td>
<td>UserCF/ItemCF</td>
<td>300</td>
<td>20ms</td>
<td>25%</td>
</tr>
<tr>
<td>å†…å®¹å¬å›</td>
<td>Embeddingç›¸ä¼¼åº¦</td>
<td>200</td>
<td>30ms</td>
<td>20%</td>
</tr>
<tr>
<td>æ ‡ç­¾å¬å›</td>
<td>æ ‡ç­¾åŒ¹é…</td>
<td>200</td>
<td>10ms</td>
<td>15%</td>
</tr>
<tr>
<td>çƒ­é—¨å¬å›</td>
<td>ç»Ÿè®¡æ’åº</td>
<td>100</td>
<td>5ms</td>
<td>10%</td>
</tr>
<tr>
<td>å…³æ³¨å¬å›</td>
<td>ç¤¾äº¤å…³ç³»</td>
<td>150</td>
<td>15ms</td>
<td>15%</td>
</tr>
<tr>
<td>å†å²å¬å›</td>
<td>åºåˆ—æ¨¡å‹</td>
<td>150</td>
<td>25ms</td>
<td>15%</td>
</tr>
</tbody>
</table>
<h4 id="_23">å‘é‡åŒ–å¬å›å®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">EmbeddingRecall</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„å¬å›å®ç°&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_embeddings</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ç”¨æˆ·å‘é‡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_embeddings</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># å†…å®¹å‘é‡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">FaissIndex</span><span class="p">()</span>  <span class="c1"># å‘é‡ç´¢å¼•</span>

    <span class="k">def</span> <span class="nf">build_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ„å»ºå‘é‡ç´¢å¼•&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨Faissæ„å»ºé«˜æ•ˆçš„å‘é‡æ£€ç´¢ç´¢å¼•</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_embeddings</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¬å›Top-Kç›¸ä¼¼å†…å®¹&quot;&quot;&quot;</span>
        <span class="n">user_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embeddings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cold_start_recall</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">user_vec</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>

        <span class="c1"># è¿‡æ»¤å·²çœ‹è¿‡çš„å†…å®¹</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_seen</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">candidates</span>
</code></pre></div>

<h3 id="23">2.3 æ’åºæ¨¡å‹æ¶æ„</h3>
<h4 id="_24">ç‰¹å¾å¤„ç†æµæ°´çº¿</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ç‰¹å¾å¤„ç†Pipeline                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  åŸå§‹ç‰¹å¾æå–                                   â”‚
â”‚    â”œâ”€â”€ å®æ—¶ç‰¹å¾ï¼ˆKafka/Redisï¼‰                 â”‚
â”‚    â””â”€â”€ ç¦»çº¿ç‰¹å¾ï¼ˆHive/HBaseï¼‰                  â”‚
â”‚              â†“                                  â”‚
â”‚  ç‰¹å¾å·¥ç¨‹                                       â”‚
â”‚    â”œâ”€â”€ æ•°å€¼ç‰¹å¾ï¼šæ ‡å‡†åŒ–ã€ç¦»æ•£åŒ–                â”‚
â”‚    â”œâ”€â”€ ç±»åˆ«ç‰¹å¾ï¼šOne-hotã€Embedding            â”‚
â”‚    â””â”€â”€ äº¤å‰ç‰¹å¾ï¼šè‡ªåŠ¨ç‰¹å¾äº¤å‰                  â”‚
â”‚              â†“                                  â”‚
â”‚  ç‰¹å¾é€‰æ‹©                                       â”‚
â”‚    â”œâ”€â”€ é‡è¦æ€§è¯„åˆ†                              â”‚
â”‚    â””â”€â”€ åœ¨çº¿ç‰¹å¾ç›‘æ§                            â”‚
â”‚              â†“                                  â”‚
â”‚  æ¨¡å‹è¾“å…¥                                       â”‚
â”‚    â””â”€â”€ Dense Vectorï¼ˆ~1000ç»´ï¼‰                 â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="_25">æ·±åº¦æ’åºç½‘ç»œ</h4>
<div class="codehilite"><pre><span></span><code>è¾“å…¥å±‚ï¼ˆ1000ç»´ï¼‰
    â†“
Embeddingå±‚
    â”œâ”€â”€ ç”¨æˆ·ID Embeddingï¼ˆ128ç»´ï¼‰
    â”œâ”€â”€ è§†é¢‘ID Embeddingï¼ˆ128ç»´ï¼‰
    â””â”€â”€ ç±»åˆ«ç‰¹å¾Embedding
    â†“
ç‰¹å¾äº¤å‰å±‚ï¼ˆWideéƒ¨åˆ†ï¼‰
    â””â”€â”€ æ‰‹å·¥ç‰¹å¾äº¤å‰
    â†“
æ·±åº¦ç½‘ç»œå±‚ï¼ˆDeepéƒ¨åˆ†ï¼‰
    â”œâ”€â”€ Hidden Layer 1ï¼ˆ512ç»´ï¼‰+ ReLU + Dropout
    â”œâ”€â”€ Hidden Layer 2ï¼ˆ256ç»´ï¼‰+ ReLU + Dropout
    â””â”€â”€ Hidden Layer 3ï¼ˆ128ç»´ï¼‰+ ReLU + Dropout
    â†“
èåˆå±‚
    â””â”€â”€ Wide &amp; Deep åˆå¹¶
    â†“
è¾“å‡ºå±‚
    â””â”€â”€ Sigmoidï¼ˆç‚¹å‡»ç‡é¢„æµ‹ï¼‰
</code></pre></div>

<h3 id="24">2.4 å®æ—¶æ¨èç³»ç»Ÿ</h3>
<h4 id="_26">æµå¼è®¡ç®—æ¶æ„</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å®æ—¶æ¨èæ•°æ®æµ                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  ç”¨æˆ·è¡Œä¸º â†’ Kafka â†’ Flink                    â”‚
â”‚                â†“                             â”‚
â”‚         å®æ—¶ç‰¹å¾è®¡ç®—                         â”‚
â”‚           â”œâ”€â”€ 5åˆ†é’Ÿæ—¶é—´çª—å£                 â”‚
â”‚           â”œâ”€â”€ ç”¨æˆ·å…´è¶£æ¼‚ç§»æ£€æµ‹              â”‚
â”‚           â””â”€â”€ çƒ­ç‚¹å‘ç°                      â”‚
â”‚                â†“                             â”‚
â”‚         Redisç‰¹å¾å­˜å‚¨                        â”‚
â”‚                â†“                             â”‚
â”‚         åœ¨çº¿æ¨ç†æœåŠ¡                         â”‚
â”‚                â†“                             â”‚
â”‚         æ¨èç»“æœ                             â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</code></pre></div>

<h4 id="_27">æ€§èƒ½æŒ‡æ ‡</h4>
<p>| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | è¯´æ˜ |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ç›®æ ‡å€¼</th>
<th>å®é™…å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç«¯åˆ°ç«¯å»¶è¿Ÿ</td>
<td>&lt;200ms</td>
<td>150ms</td>
<td>ä»è¯·æ±‚åˆ°è¿”å›</td>
</tr>
<tr>
<td>å¬å›å»¶è¿Ÿ</td>
<td>&lt;50ms</td>
<td>35ms</td>
<td>å¤šè·¯å¬å›æ€»è€—æ—¶</td>
</tr>
<tr>
<td>æ’åºå»¶è¿Ÿ</td>
<td>&lt;100ms</td>
<td>80ms</td>
<td>æ¨¡å‹æ¨ç†æ—¶é—´</td>
</tr>
<tr>
<td>QPS</td>
<td>100K</td>
<td>120K</td>
<td>å•æœºå¤„ç†èƒ½åŠ›</td>
</tr>
<tr>
<td>ç¼“å­˜å‘½ä¸­ç‡</td>
<td>&gt;80%</td>
<td>85%</td>
<td>Redisç¼“å­˜</td>
</tr>
</tbody>
</table>
<h3 id="25">2.5 åˆ†å¸ƒå¼è®­ç»ƒæ¶æ„</h3>
<h4 id="_28">å‚æ•°æœåŠ¡å™¨æ¨¡å¼</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Parameter Serveræ¶æ„                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Parameter Serversï¼ˆå‚æ•°æœåŠ¡å™¨ï¼‰           â”‚
â”‚     â”œâ”€â”€ PS1ï¼šå­˜å‚¨Embeddingå‚æ•°             â”‚
â”‚     â”œâ”€â”€ PS2ï¼šå­˜å‚¨Denseå‚æ•°                 â”‚
â”‚     â””â”€â”€ PS3ï¼šå¤‡ä»½ä¸å®¹é”™                    â”‚
â”‚              â†“ â†‘                           â”‚
â”‚                                            â”‚
â”‚  Worker Nodesï¼ˆè®¡ç®—èŠ‚ç‚¹ï¼‰                  â”‚
â”‚     â”œâ”€â”€ Worker1ï¼šè®­ç»ƒBatch1                â”‚
â”‚     â”œâ”€â”€ Worker2ï¼šè®­ç»ƒBatch2                â”‚
â”‚     â”œâ”€â”€ Worker3ï¼šè®­ç»ƒBatch3                â”‚
â”‚     â””â”€â”€ Worker4ï¼šè®­ç»ƒBatch4                â”‚
â”‚              â†“                             â”‚
â”‚                                            â”‚
â”‚  Model Servingï¼ˆæ¨¡å‹æœåŠ¡ï¼‰                 â”‚
â”‚     â””â”€â”€ TensorFlow Servingé›†ç¾¤             â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="_29">æ·±åº¦å­¦ä¹ åº”ç”¨</h2>
<h3 id="31">3.1 æ¨¡å‹æ¼”è¿›å†ç¨‹</h3>
<h4 id="_30">æ·±åº¦å­¦ä¹ æŠ€æœ¯æ ˆæ—¶é—´çº¿</h4>
<div class="codehilite"><pre><span></span><code><span class="mi">2017</span><span class="o">:</span><span class="w"> </span><span class="n">DNN</span><span class="w"> </span><span class="o">(</span><span class="n">Deep</span><span class="w"> </span><span class="n">Neural</span><span class="w"> </span><span class="n">Network</span><span class="o">)</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="mi">3</span><span class="err">å±‚å…¨è¿æ¥ç½‘ç»œ</span>
<span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">ç‰¹å¾ç»´åº¦ï¼š</span><span class="mi">500</span>

<span class="mi">2018</span><span class="o">:</span><span class="w"> </span><span class="n">Wide</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Deep</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Wideéƒ¨åˆ†</span><span class="err">ï¼šçº¿æ€§æ¨¡å‹</span>
<span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Deepéƒ¨åˆ†</span><span class="err">ï¼š</span><span class="mi">4</span><span class="err">å±‚</span><span class="n">DNN</span>

<span class="mi">2019</span><span class="o">:</span><span class="w"> </span><span class="n">DeepFM</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">FMç‰¹å¾äº¤å‰</span>
<span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Deepç½‘ç»œå­¦ä¹ é«˜é˜¶ç‰¹å¾</span>

<span class="mi">2020</span><span class="o">:</span><span class="w"> </span><span class="n">DIEN</span><span class="w"> </span><span class="o">(</span><span class="n">Deep</span><span class="w"> </span><span class="n">Interest</span><span class="w"> </span><span class="n">Evolution</span><span class="w"> </span><span class="n">Network</span><span class="o">)</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">å…´è¶£æŠ½å–å±‚</span>
<span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">å…´è¶£æ¼”åŒ–å±‚</span>

<span class="mi">2021</span><span class="o">:</span><span class="w"> </span><span class="n">Multi</span><span class="o">-</span><span class="n">Task</span><span class="w"> </span><span class="n">Learning</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">ç‚¹å‡»ç‡é¢„æµ‹</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">å®Œæ’­ç‡é¢„æµ‹</span>
<span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">äº’åŠ¨ç‡é¢„æµ‹</span>

<span class="mi">2022</span><span class="o">:</span><span class="w"> </span><span class="n">Transformeråº”ç”¨</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Self</span><span class="o">-</span><span class="n">Attentionæœºåˆ¶</span>
<span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">é•¿åºåˆ—å»ºæ¨¡</span>

<span class="mi">2023</span><span class="o">:</span><span class="w"> </span><span class="err">å¤§æ¨¡å‹èåˆ</span>
<span class="w">      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">LLMç‰¹å¾æå–</span>
<span class="w">      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">å¤šæ¨¡æ€ç†è§£</span>
</code></pre></div>

<h3 id="32">3.2 æ ¸å¿ƒæ¨¡å‹è¯¦è§£</h3>
<h4 id="dien">DIENæ¶æ„å®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DIEN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ·±åº¦å…´è¶£æ¼”åŒ–ç½‘ç»œ&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># å…´è¶£æŠ½å–å±‚ï¼ˆGRUï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interest_extractor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># å…´è¶£æ¼”åŒ–å±‚ï¼ˆAUGRUï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interest_evolution</span> <span class="o">=</span> <span class="n">AUGRU</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span>
        <span class="p">)</span>

        <span class="c1"># Attentionæœºåˆ¶</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">MultiHeadAttention</span><span class="p">(</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">num_heads</span>
        <span class="p">)</span>

        <span class="c1"># é¢„æµ‹å±‚</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_seq</span><span class="p">,</span> <span class="n">target_item</span><span class="p">,</span> <span class="n">neg_items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># å…´è¶£æŠ½å–</span>
        <span class="n">interests</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interest_extractor</span><span class="p">(</span><span class="n">user_seq</span><span class="p">)</span>

        <span class="c1"># è¾…åŠ©æŸå¤±ï¼ˆä½¿ç”¨è´Ÿæ ·æœ¬ï¼‰</span>
        <span class="k">if</span> <span class="n">neg_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aux_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_loss</span><span class="p">(</span><span class="n">interests</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">)</span>

        <span class="c1"># å…´è¶£æ¼”åŒ–</span>
        <span class="n">evolved_interests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interest_evolution</span><span class="p">(</span>
            <span class="n">interests</span><span class="p">,</span> <span class="n">target_item</span>
        <span class="p">)</span>

        <span class="c1"># Attention pooling</span>
        <span class="n">final_interest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span>
            <span class="n">evolved_interests</span><span class="p">,</span> <span class="n">target_item</span>
        <span class="p">)</span>

        <span class="c1"># é¢„æµ‹</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">(</span><span class="n">final_interest</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">aux_loss</span> <span class="k">if</span> <span class="n">neg_items</span> <span class="k">else</span> <span class="n">output</span>
</code></pre></div>

<h4 id="_31">å¤šä»»åŠ¡å­¦ä¹ æ¡†æ¶</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å¤šä»»åŠ¡å­¦ä¹ æ¶æ„ï¼ˆMMOEï¼‰             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  è¾“å…¥ç‰¹å¾                                    â”‚
â”‚     â†“                                        â”‚
â”‚  å…±äº«åº•å±‚ï¼ˆShared Bottomï¼‰                   â”‚
â”‚     â”œâ”€â”€ Expert 1ï¼šç”¨æˆ·è¡Œä¸ºä¸“å®¶              â”‚
â”‚     â”œâ”€â”€ Expert 2ï¼šå†…å®¹ç†è§£ä¸“å®¶              â”‚
â”‚     â”œâ”€â”€ Expert 3ï¼šä¸Šä¸‹æ–‡ä¸“å®¶                â”‚
â”‚     â””â”€â”€ Expert 4ï¼šç»Ÿè®¡ç‰¹å¾ä¸“å®¶              â”‚
â”‚            â†“                                 â”‚
â”‚  é—¨æ§ç½‘ç»œï¼ˆGating Networkï¼‰                  â”‚
â”‚     â”œâ”€â”€ Gate 1 â†’ ç‚¹å‡»ç‡ä»»åŠ¡                 â”‚
â”‚     â”œâ”€â”€ Gate 2 â†’ å®Œæ’­ç‡ä»»åŠ¡                 â”‚
â”‚     â””â”€â”€ Gate 3 â†’ äº’åŠ¨ç‡ä»»åŠ¡                 â”‚
â”‚            â†“                                 â”‚
â”‚  ä»»åŠ¡ç‰¹å®šå±‚ï¼ˆTask-specificï¼‰                 â”‚
â”‚     â”œâ”€â”€ Tower 1ï¼šCTRé¢„æµ‹                    â”‚
â”‚     â”œâ”€â”€ Tower 2ï¼šå®Œæ’­ç‡é¢„æµ‹                 â”‚
â”‚     â””â”€â”€ Tower 3ï¼šäº’åŠ¨ç‡é¢„æµ‹                 â”‚
â”‚            â†“                                 â”‚
â”‚  å¤šç›®æ ‡ä¼˜åŒ–                                  â”‚
â”‚     â””â”€â”€ Loss = Î±*L_ctr + Î²*L_finish + Î³*L_interact â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="33">3.3 ç‰¹å¾å·¥ç¨‹åˆ›æ–°</h3>
<h4 id="_32">å¤šæ¨¡æ€ç‰¹å¾èåˆ</h4>
<p>| æ¨¡æ€ç±»å‹ | ç‰¹å¾æå–æ–¹æ³• | ç»´åº¦ | åº”ç”¨åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th>æ¨¡æ€ç±»å‹</th>
<th>ç‰¹å¾æå–æ–¹æ³•</th>
<th>ç»´åº¦</th>
<th>åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>è§†é¢‘å¸§</td>
<td>ResNet/ViT</td>
<td>2048</td>
<td>å†…å®¹ç†è§£</td>
</tr>
<tr>
<td>éŸ³é¢‘</td>
<td>Wav2Vec</td>
<td>768</td>
<td>éŸ³ä¹/è¯­éŸ³è¯†åˆ«</td>
</tr>
<tr>
<td>æ–‡æœ¬</td>
<td>BERT/RoBERTa</td>
<td>768</td>
<td>æ ‡é¢˜/å¼¹å¹•ç†è§£</td>
</tr>
<tr>
<td>ç”¨æˆ·è¡Œä¸º</td>
<td>RNN/Transformer</td>
<td>512</td>
<td>åºåˆ—å»ºæ¨¡</td>
</tr>
<tr>
<td>å›¾ç»“æ„</td>
<td>GNN</td>
<td>256</td>
<td>ç¤¾äº¤å…³ç³»</td>
</tr>
</tbody>
</table>
<h4 id="_33">å®æ—¶ç‰¹å¾å·¥ç¨‹</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RealtimeFeatureEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å®æ—¶ç‰¹å¾è®¡ç®—å¼•æ“&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kafka_consumer</span> <span class="o">=</span> <span class="n">KafkaConsumer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">compute_user_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># çŸ­æœŸå…´è¶£ï¼ˆ5åˆ†é’Ÿçª—å£ï¼‰</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_behaviors</span><span class="p">(</span>
            <span class="n">user_id</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;5m&#39;</span>
        <span class="p">)</span>

        <span class="c1"># ä¸­æœŸå…´è¶£ï¼ˆ1å°æ—¶çª—å£ï¼‰</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;medium_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_behaviors</span><span class="p">(</span>
            <span class="n">user_id</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span>
        <span class="p">)</span>

        <span class="c1"># å®æ—¶ç»Ÿè®¡ç‰¹å¾</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;realtime_stats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;click_rate_5m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_ctr</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">&#39;5m&#39;</span><span class="p">),</span>
            <span class="s1">&#39;watch_time_avg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_avg_watch_time</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
            <span class="s1">&#39;interaction_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_interaction_rate</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># ä¸Šä¸‹æ–‡ç‰¹å¾</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_features</span><span class="p">(),</span>
            <span class="s1">&#39;device_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_device_info</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
            <span class="s1">&#39;network_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_network_info</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">features</span>
</code></pre></div>

<h3 id="34">3.4 æ¨¡å‹ä¼˜åŒ–æŠ€æœ¯</h3>
<h4 id="_34">æ¨¡å‹å‹ç¼©ä¸åŠ é€Ÿ</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ¨¡å‹ä¼˜åŒ–Pipeline                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  åŸå§‹æ¨¡å‹ï¼ˆ1GBï¼‰                            â”‚
â”‚     â†“                                       â”‚
â”‚  çŸ¥è¯†è’¸é¦ï¼ˆKnowledge Distillationï¼‰         â”‚
â”‚     Teacher Model â†’ Student Model           â”‚
â”‚     å‹ç¼©ç‡ï¼š4x                              â”‚
â”‚     â†“                                       â”‚
â”‚  é‡åŒ–ï¼ˆQuantizationï¼‰                       â”‚
â”‚     FP32 â†’ INT8                            â”‚
â”‚     å‹ç¼©ç‡ï¼š4x                              â”‚
â”‚     â†“                                       â”‚
â”‚  å‰ªæï¼ˆPruningï¼‰                            â”‚
â”‚     ç§»é™¤å†—ä½™è¿æ¥                            â”‚
â”‚     å‹ç¼©ç‡ï¼š2x                              â”‚
â”‚     â†“                                       â”‚
â”‚  ä¼˜åŒ–åæ¨¡å‹ï¼ˆ31.25MBï¼‰                      â”‚
â”‚     æ¨ç†é€Ÿåº¦æå‡ï¼š10x                       â”‚
â”‚     ç²¾åº¦æŸå¤±ï¼š&lt;1%                           â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="_35">åœ¨çº¿å­¦ä¹ ç³»ç»Ÿ</h4>
<p>| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | åŠŸèƒ½ | æ€§èƒ½æŒ‡æ ‡ |</p>
<table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>æŠ€æœ¯é€‰å‹</th>
<th>åŠŸèƒ½</th>
<th>æ€§èƒ½æŒ‡æ ‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç‰¹å¾æ›´æ–°</td>
<td>Flink</td>
<td>å®æ—¶ç‰¹å¾è®¡ç®—</td>
<td>å»¶è¿Ÿ&lt;100ms</td>
</tr>
<tr>
<td>æ¨¡å‹æ›´æ–°</td>
<td>Parameter Server</td>
<td>å¢é‡è®­ç»ƒ</td>
<td>5åˆ†é’Ÿæ›´æ–°å‘¨æœŸ</td>
</tr>
<tr>
<td>æ•ˆæœè¯„ä¼°</td>
<td>A/B Testing</td>
<td>å®æ—¶æ•ˆæœç›‘æ§</td>
<td>ç§’çº§æŒ‡æ ‡</td>
</tr>
<tr>
<td>å›æ»šæœºåˆ¶</td>
<td>Model Registry</td>
<td>ç‰ˆæœ¬ç®¡ç†</td>
<td>1åˆ†é’Ÿå›æ»š</td>
</tr>
</tbody>
</table>
<h3 id="35">3.5 å‰æ²¿æŠ€æœ¯æ¢ç´¢</h3>
<h4 id="transformer">Transformeråœ¨æ¨èä¸­çš„åº”ç”¨</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">BST</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Behavior Sequence Transformer&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Position encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_encoding</span> <span class="o">=</span> <span class="n">PositionalEncoding</span><span class="p">(</span>
            <span class="n">d_model</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">d_model</span><span class="p">,</span>
            <span class="n">max_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_seq_len</span>
        <span class="p">)</span>

        <span class="c1"># Multi-head self-attention blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer_blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">TransformerBlock</span><span class="p">(</span>
                <span class="n">d_model</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">d_model</span><span class="p">,</span>
                <span class="n">n_heads</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span>
                <span class="n">d_ff</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">d_ff</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">n_blocks</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># Target attention</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_attention</span> <span class="o">=</span> <span class="n">TargetAttention</span><span class="p">(</span>
            <span class="n">d_model</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">d_model</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">behavior_sequence</span><span class="p">,</span> <span class="n">target_item</span><span class="p">):</span>
        <span class="c1"># æ·»åŠ ä½ç½®ç¼–ç </span>
        <span class="n">seq_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_encoding</span><span class="p">(</span><span class="n">behavior_sequence</span><span class="p">)</span>

        <span class="c1"># Transformer blocks</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_blocks</span><span class="p">:</span>
            <span class="n">seq_emb</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">seq_emb</span><span class="p">)</span>

        <span class="c1"># Target-aware attention</span>
        <span class="n">user_interest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_attention</span><span class="p">(</span>
            <span class="n">seq_emb</span><span class="p">,</span> <span class="n">target_item</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">user_interest</span>
</code></pre></div>

<h4 id="_36">å›¾ç¥ç»ç½‘ç»œåº”ç”¨</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å›¾ç¥ç»ç½‘ç»œæ¨èæ¶æ„                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  ç”¨æˆ·-ç‰©å“äºŒéƒ¨å›¾                             â”‚
â”‚     â”œâ”€â”€ ç”¨æˆ·èŠ‚ç‚¹ï¼š100M+                     â”‚
â”‚     â”œâ”€â”€ ç‰©å“èŠ‚ç‚¹ï¼š10M+                      â”‚
â”‚     â””â”€â”€ è¾¹ï¼šäº¤äº’å…³ç³»                        â”‚
â”‚              â†“                               â”‚
â”‚  å›¾å·ç§¯å±‚ï¼ˆGCNï¼‰                             â”‚
â”‚     â”œâ”€â”€ Layer 1ï¼šé‚»å±…èšåˆ                   â”‚
â”‚     â”œâ”€â”€ Layer 2ï¼šç‰¹å¾ä¼ æ’­                   â”‚
â”‚     â””â”€â”€ Layer 3ï¼šé«˜é˜¶å…³ç³»                   â”‚
â”‚              â†“                               â”‚
â”‚  èŠ‚ç‚¹Embedding                               â”‚
â”‚     â”œâ”€â”€ ç”¨æˆ·Embedding                       â”‚
â”‚     â””â”€â”€ ç‰©å“Embedding                       â”‚
â”‚              â†“                               â”‚
â”‚  ç›¸ä¼¼åº¦è®¡ç®—                                  â”‚
â”‚     â””â”€â”€ å†…ç§¯/ä½™å¼¦ç›¸ä¼¼åº¦                      â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="_37">ç”¨æˆ·ç”»åƒç³»ç»Ÿ</h2>
<h3 id="41_1">4.1 ç”»åƒä½“ç³»æ¶æ„</h3>
<h4 id="_38">å¤šå±‚æ¬¡ç”¨æˆ·ç”»åƒ</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Bç«™ç”¨æˆ·ç”»åƒä½“ç³»                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  åŸºç¡€å±æ€§å±‚                                  â”‚
â”‚   â”œâ”€â”€ äººå£ç»Ÿè®¡ï¼šå¹´é¾„ã€æ€§åˆ«ã€åœ°åŸŸ            â”‚
â”‚   â”œâ”€â”€ è®¾å¤‡ä¿¡æ¯ï¼šæœºå‹ã€ç³»ç»Ÿã€ç½‘ç»œ            â”‚
â”‚   â””â”€â”€ è´¦å·ä¿¡æ¯ï¼šç­‰çº§ã€å¤§ä¼šå‘˜ã€æ³¨å†Œæ—¶é—´      â”‚
â”‚                                              â”‚
â”‚  è¡Œä¸ºç‰¹å¾å±‚                                  â”‚
â”‚   â”œâ”€â”€ è§‚çœ‹è¡Œä¸ºï¼šæ—¶é•¿ã€é¢‘æ¬¡ã€å®Œæ’­ç‡          â”‚
â”‚   â”œâ”€â”€ äº’åŠ¨è¡Œä¸ºï¼šç‚¹èµã€æŠ•å¸ã€æ”¶è—ã€å¼¹å¹•      â”‚
â”‚   â”œâ”€â”€ ç¤¾äº¤è¡Œä¸ºï¼šå…³æ³¨ã€ç§ä¿¡ã€åŠ¨æ€            â”‚
â”‚   â””â”€â”€ åˆ›ä½œè¡Œä¸ºï¼šæŠ•ç¨¿ã€ç›´æ’­ã€ä¸“æ             â”‚
â”‚                                              â”‚
â”‚  å…´è¶£æ ‡ç­¾å±‚                                  â”‚
â”‚   â”œâ”€â”€ å†…å®¹åå¥½ï¼šåˆ†åŒºã€æ ‡ç­¾ã€UPä¸»            â”‚
â”‚   â”œâ”€â”€ æ—¶é—´åå¥½ï¼šæ´»è·ƒæ—¶æ®µã€è§‚çœ‹èŠ‚å¥          â”‚
â”‚   â””â”€â”€ æ¶ˆè´¹åå¥½ï¼šä»˜è´¹æ„æ„¿ã€æ‰“èµä¹ æƒ¯          â”‚
â”‚                                              â”‚
â”‚  ä»·å€¼åˆ†å±‚                                    â”‚
â”‚   â”œâ”€â”€ ç”¨æˆ·ä»·å€¼ï¼šLTVã€æ´»è·ƒåº¦ã€ç•™å­˜          â”‚
â”‚   â”œâ”€â”€ å†…å®¹ä»·å€¼ï¼šå†…å®¹æ¶ˆè´¹é‡ã€è´¨é‡åå¥½        â”‚
â”‚   â””â”€â”€ ç¤¾åŒºä»·å€¼ï¼šUGCè´¡çŒ®ã€ç¤¾äº¤å½±å“åŠ›         â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="42_1">4.2 æ ‡ç­¾ä½“ç³»å»ºè®¾</h3>
<h4 id="_39">æ ‡ç­¾åˆ†ç±»æ¶æ„</h4>
<p>| æ ‡ç­¾ç±»å‹ | æ•°é‡çº§ | æ›´æ–°é¢‘ç‡ | åº”ç”¨åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th>æ ‡ç­¾ç±»å‹</th>
<th>æ•°é‡çº§</th>
<th>æ›´æ–°é¢‘ç‡</th>
<th>åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŸºç¡€æ ‡ç­¾</td>
<td>100+</td>
<td>æ¯å¤©</td>
<td>ç”¨æˆ·åˆ†ç¾¤</td>
</tr>
<tr>
<td>å…´è¶£æ ‡ç­¾</td>
<td>5000+</td>
<td>å®æ—¶</td>
<td>å†…å®¹æ¨è</td>
</tr>
<tr>
<td>è¡Œä¸ºæ ‡ç­¾</td>
<td>1000+</td>
<td>æ¯å°æ—¶</td>
<td>è¡Œä¸ºé¢„æµ‹</td>
</tr>
<tr>
<td>é¢„æµ‹æ ‡ç­¾</td>
<td>500+</td>
<td>æ¯å¤©</td>
<td>æµå¤±é¢„è­¦</td>
</tr>
<tr>
<td>åœˆå±‚æ ‡ç­¾</td>
<td>200+</td>
<td>æ¯å‘¨</td>
<td>ç¤¾ç¾¤è¿è¥</td>
</tr>
</tbody>
</table>
<h4 id="pipeline_1">æ ‡ç­¾ç”ŸæˆPipeline</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TagGenerationPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç”¨æˆ·æ ‡ç­¾ç”Ÿæˆæµæ°´çº¿&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_engine</span> <span class="o">=</span> <span class="n">RuleEngine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_storage</span> <span class="o">=</span> <span class="n">TagStorage</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_interest_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆå…´è¶£æ ‡ç­¾&quot;&quot;&quot;</span>
        <span class="c1"># è·å–ç”¨æˆ·è¡Œä¸ºåºåˆ—</span>
        <span class="n">behaviors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_behaviors</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># å†…å®¹æ ‡ç­¾èšåˆ</span>
        <span class="n">content_tags</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="n">behaviors</span><span class="p">:</span>
            <span class="n">video_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_video_tags</span><span class="p">(</span><span class="n">behavior</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_weight</span><span class="p">(</span><span class="n">behavior</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">video_tags</span><span class="p">:</span>
                <span class="n">content_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="c1"># TF-IDFæ ‡å‡†åŒ–</span>
        <span class="n">user_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfidf_normalize</span><span class="p">(</span><span class="n">content_tags</span><span class="p">)</span>

        <span class="c1"># æ ‡ç­¾è¡°å‡ï¼ˆæ—¶é—´è¡°å‡å› å­ï¼‰</span>
        <span class="n">decayed_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_time_decay</span><span class="p">(</span><span class="n">user_tags</span><span class="p">)</span>

        <span class="c1"># é˜ˆå€¼è¿‡æ»¤</span>
        <span class="n">final_tags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tag</span><span class="p">:</span> <span class="n">score</span> 
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">decayed_tags</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.3</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">final_tags</span>

    <span class="k">def</span> <span class="nf">calculate_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">behavior</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—è¡Œä¸ºæƒé‡&quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="s1">&#39;coin&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s1">&#39;favorite&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s1">&#39;share&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="mf">2.5</span>
        <span class="p">}</span>

        <span class="c1"># å®Œæ’­ç‡åŠ æƒ</span>
        <span class="n">completion_rate</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">watch_time</span> <span class="o">/</span> <span class="n">behavior</span><span class="o">.</span><span class="n">video_duration</span>
        <span class="n">base_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">behavior</span><span class="o">.</span><span class="n">action_type</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">base_weight</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">completion_rate</span><span class="p">)</span>
</code></pre></div>

<h3 id="43_1">4.3 ç”¨æˆ·åˆ†ç¾¤ç­–ç•¥</h3>
<h4 id="_40">æ ¸å¿ƒç”¨æˆ·åˆ†ç¾¤</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·åˆ†ç¾¤çŸ©é˜µ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  æ´»è·ƒåº¦ç»´åº¦                                  â”‚
â”‚   é«˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚      â”‚æ ¸å¿ƒç”¨æˆ·â”‚æ´»è·ƒç”¨æˆ·â”‚æ™®é€šç”¨æˆ·â”‚          â”‚
â”‚   ä¸­ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚      â”‚å¿ å®ç”¨æˆ·â”‚å¸¸è§„ç”¨æˆ·â”‚ä½é¢‘ç”¨æˆ·â”‚          â”‚
â”‚   ä½ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚      â”‚å›æµç”¨æˆ·â”‚æ²‰ç¡ç”¨æˆ·â”‚æµå¤±ç”¨æˆ·â”‚          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        é«˜      ä¸­      ä½                    â”‚
â”‚            ä»·å€¼åº¦ç»´åº¦                        â”‚
â”‚                                              â”‚
â”‚  åˆ†ç¾¤ç­–ç•¥                                    â”‚
â”‚   â€¢ æ ¸å¿ƒç”¨æˆ·ï¼šä¸“å±æƒç›Šã€ä¼˜å…ˆä½“éªŒ            â”‚
â”‚   â€¢ æ´»è·ƒç”¨æˆ·ï¼šå†…å®¹ç²¾æ¨ã€ç¤¾åŒºäº’åŠ¨            â”‚
â”‚   â€¢ æ²‰ç¡ç”¨æˆ·ï¼šå¬å›ç­–ç•¥ã€æ¿€åŠ±å”¤é†’            â”‚
â”‚   â€¢ æ–°ç”¨æˆ·ï¼šå¼•å¯¼æ•™è‚²ã€å…´è¶£æ¢ç´¢              â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="rfm_1">RFMæ¨¡å‹åº”ç”¨</h4>
<p>| ç»´åº¦ | å®šä¹‰ | è®¡ç®—æ–¹æ³• | åˆ†å±‚é˜ˆå€¼ |</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>å®šä¹‰</th>
<th>è®¡ç®—æ–¹æ³•</th>
<th>åˆ†å±‚é˜ˆå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>R(Recency)</td>
<td>æœ€è¿‘æ´»è·ƒ</td>
<td>è·ä»Šå¤©æ•°</td>
<td>1/3/7/30å¤©</td>
</tr>
<tr>
<td>F(Frequency)</td>
<td>æ´»è·ƒé¢‘æ¬¡</td>
<td>æœˆå‡æ´»è·ƒå¤©æ•°</td>
<td>1/5/15/25å¤©</td>
</tr>
<tr>
<td>M(Monetary)</td>
<td>æ¶ˆè´¹ä»·å€¼</td>
<td>æœˆå‡æ¶ˆè´¹é‡‘é¢</td>
<td>Â¥0/10/50/200</td>
</tr>
</tbody>
</table>
<h3 id="44_1">4.4 å®æ—¶ç”»åƒæ›´æ–°</h3>
<h4 id="_41">æµå¼è®¡ç®—æ¶æ„</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å®æ—¶ç”»åƒæ›´æ–°ç³»ç»Ÿ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  æ•°æ®æº                                      â”‚
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯åŸ‹ç‚¹ â†’ Kafka                    â”‚
â”‚   â”œâ”€â”€ æœåŠ¡ç«¯æ—¥å¿— â†’ Flume                    â”‚
â”‚   â””â”€â”€ æ•°æ®åº“Binlog â†’ Canal                  â”‚
â”‚                â†“                             â”‚
â”‚  å®æ—¶è®¡ç®—å±‚ï¼ˆFlinkï¼‰                         â”‚
â”‚   â”œâ”€â”€ äº‹ä»¶æ¸…æ´—ï¼šå»é‡ã€è¿‡æ»¤ã€æ ‡å‡†åŒ–          â”‚
â”‚   â”œâ”€â”€ ç‰¹å¾è®¡ç®—ï¼šæ»‘åŠ¨çª—å£èšåˆ                â”‚
â”‚   â””â”€â”€ æ ‡ç­¾æ›´æ–°ï¼šå¢é‡è®¡ç®—                    â”‚
â”‚                â†“                             â”‚
â”‚  å­˜å‚¨å±‚                                      â”‚
â”‚   â”œâ”€â”€ Redisï¼šçƒ­æ•°æ®ï¼ˆ1å¤©å†…ï¼‰                â”‚
â”‚   â”œâ”€â”€ HBaseï¼šæ¸©æ•°æ®ï¼ˆ30å¤©å†…ï¼‰               â”‚
â”‚   â””â”€â”€ Hiveï¼šå†·æ•°æ®ï¼ˆå†å²å½’æ¡£ï¼‰              â”‚
â”‚                â†“                             â”‚
â”‚  æœåŠ¡å±‚                                      â”‚
â”‚   â””â”€â”€ ç”»åƒæŸ¥è¯¢APIï¼ˆQPS: 100K+ï¼‰             â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="_42">ç”»åƒæ›´æ–°ç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ProfileUpdateStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç”»åƒæ›´æ–°ç­–ç•¥&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisCluster</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hbase</span> <span class="o">=</span> <span class="n">HBaseClient</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_realtime_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å®æ—¶ç”»åƒæ›´æ–°&quot;&quot;&quot;</span>
        <span class="c1"># çŸ­æœŸè¡Œä¸ºåºåˆ—æ›´æ–°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_behavior_sequence</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="c1"># å®æ—¶ç»Ÿè®¡æŒ‡æ ‡æ›´æ–°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_statistics</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="c1"># å…´è¶£æ ‡ç­¾å¢é‡æ›´æ–°</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;favorite&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_interest_tags</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="c1"># è§¦å‘è§„åˆ™å¼•æ“</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_rules</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_behavior_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ›´æ–°è¡Œä¸ºåºåˆ—ï¼ˆä¿ç•™æœ€è¿‘1000æ¡ï¼‰&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user:behavior:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># ä½¿ç”¨Redis Listå­˜å‚¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">ltrim</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>  <span class="c1"># 1å¤©è¿‡æœŸ</span>

    <span class="k">def</span> <span class="nf">merge_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤šæ—¶é—´å°ºåº¦ç”»åƒèåˆ&quot;&quot;&quot;</span>
        <span class="c1"># å®æ—¶ç”»åƒï¼ˆ5åˆ†é’Ÿï¼‰</span>
        <span class="n">realtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_realtime_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># è¿‘æœŸç”»åƒï¼ˆ1å¤©ï¼‰</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># é•¿æœŸç”»åƒï¼ˆ30å¤©ï¼‰</span>
        <span class="n">longterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longterm_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># åŠ æƒèåˆ</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;interests&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_interests</span><span class="p">(</span>
                <span class="n">realtime</span><span class="o">.</span><span class="n">interests</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">recent</span><span class="o">.</span><span class="n">interests</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="n">longterm</span><span class="o">.</span><span class="n">interests</span> <span class="o">*</span> <span class="mf">0.2</span>
            <span class="p">),</span>
            <span class="s1">&#39;behaviors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_behaviors</span><span class="p">(</span>
                <span class="n">realtime</span><span class="p">,</span> <span class="n">recent</span><span class="p">,</span> <span class="n">longterm</span>
            <span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">merged</span>
</code></pre></div>

<h3 id="45_1">4.5 ç”»åƒåº”ç”¨åœºæ™¯</h3>
<h4 id="_43">ä¸ªæ€§åŒ–æ¨è</h4>
<div class="codehilite"><pre><span></span><code>ç”¨æˆ·ç”»åƒ â†’ å¬å›ç­–ç•¥
  â”œâ”€â”€ å…´è¶£æ ‡ç­¾ â†’ æ ‡ç­¾å¬å›
  â”œâ”€â”€ è¡Œä¸ºåºåˆ— â†’ ååŒè¿‡æ»¤
  â”œâ”€â”€ ç¤¾äº¤å…³ç³» â†’ ç¤¾äº¤æ¨è
  â””â”€â”€ æ¶ˆè´¹èƒ½åŠ› â†’ ä»˜è´¹å†…å®¹æ¨è
</code></pre></div>

<h4 id="_44">ç²¾å‡†è¥é”€</h4>
<p>| åœºæ™¯ | ç”»åƒç»´åº¦ | ç­–ç•¥ | æ•ˆæœ |</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>ç”»åƒç»´åº¦</th>
<th>ç­–ç•¥</th>
<th>æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ‹‰æ–°</td>
<td>ç›¸ä¼¼äººç¾¤</td>
<td>Look-alike</td>
<td>CTR +30%</td>
</tr>
<tr>
<td>ä¿ƒæ´»</td>
<td>æ²‰ç¡ç”¨æˆ·</td>
<td>Pushå¬å›</td>
<td>å”¤é†’ç‡ 15%</td>
</tr>
<tr>
<td>ä»˜è´¹è½¬åŒ–</td>
<td>ä»˜è´¹æ„æ„¿</td>
<td>å®šå‘ä¼˜æƒ </td>
<td>è½¬åŒ–ç‡ +50%</td>
</tr>
<tr>
<td>é˜²æµå¤±</td>
<td>æµå¤±é¢„è­¦</td>
<td>æŒ½ç•™ç­–ç•¥</td>
<td>ç•™å­˜ +20%</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="ab">ABæµ‹è¯•å¹³å°</h2>
<h3 id="51">5.1 å¹³å°æ¶æ„æ¼”è¿›</h3>
<h4 id="_45">å‘å±•å†ç¨‹</h4>
<div class="codehilite"><pre><span></span><code><span class="mi">2015</span><span class="o">:</span><span class="w"> </span><span class="err">æ‰‹å·¥</span><span class="n">ABæµ‹è¯•</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Excelè®°å½•å®éªŒ</span>
<span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">äººå·¥åˆ†ææ•°æ®</span>

<span class="mi">2016</span><span class="o">:</span><span class="w"> </span><span class="err">åˆä»£</span><span class="n">ABå¹³å°</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">ç®€å•åˆ†æµç³»ç»Ÿ</span>
<span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">åŸºç¡€æŒ‡æ ‡ç»Ÿè®¡</span>

<span class="mi">2018</span><span class="o">:</span><span class="w"> </span><span class="err">å¹³å°åŒ–å»ºè®¾</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">å®éªŒç®¡ç†ç³»ç»Ÿ</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">è‡ªåŠ¨åŒ–åˆ†æ</span>
<span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">å¤šå±‚å®éªŒæ¡†æ¶</span>

<span class="mi">2020</span><span class="o">:</span><span class="w"> </span><span class="err">æ™ºèƒ½åŒ–å‡çº§</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">è‡ªåŠ¨è°ƒå‚</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">æ—©åœæœºåˆ¶</span>
<span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">å› æœæ¨æ–­</span>

<span class="mi">2023</span><span class="o">:</span><span class="w"> </span><span class="err">å…¨åŸŸå®éªŒå¹³å°</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">ç«¯åˆ°ç«¯å®éªŒ</span>
<span class="w">     </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">å¤šä¸šåŠ¡çº¿æ”¯æŒ</span>
<span class="w">     </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">å®æ—¶å†³ç­–ç³»ç»Ÿ</span>
</code></pre></div>

<h4 id="_46">ç³»ç»Ÿæ¶æ„</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Bç«™ABæµ‹è¯•å¹³å°æ¶æ„                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  å®éªŒé…ç½®å±‚                                  â”‚
â”‚   â”œâ”€â”€ å®éªŒç®¡ç†UI                            â”‚
â”‚   â”œâ”€â”€ å‚æ•°é…ç½®                              â”‚
â”‚   â””â”€â”€ å®¡æ‰¹æµç¨‹                              â”‚
â”‚                â†“                             â”‚
â”‚  åˆ†æµæœåŠ¡å±‚                                  â”‚
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ†æµï¼ˆå“ˆå¸Œåˆ†æ¡¶ï¼‰                  â”‚
â”‚   â”œâ”€â”€ æµé‡éš”ç¦»ï¼ˆæ­£äº¤å®éªŒï¼‰                  â”‚
â”‚   â””â”€â”€ ç°åº¦å‘å¸ƒ                              â”‚
â”‚                â†“                             â”‚
â”‚  å®éªŒæ‰§è¡Œå±‚                                  â”‚
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯SDK                             â”‚
â”‚   â”œâ”€â”€ æœåŠ¡ç«¯SDK                             â”‚
â”‚   â””â”€â”€ é…ç½®ä¸­å¿ƒ                              â”‚
â”‚                â†“                             â”‚
â”‚  æ•°æ®æ”¶é›†å±‚                                  â”‚
â”‚   â”œâ”€â”€ åŸ‹ç‚¹é‡‡é›†                              â”‚
â”‚   â”œâ”€â”€ æ—¥å¿—èšåˆ                              â”‚
â”‚   â””â”€â”€ å®æ—¶æµå¤„ç†                            â”‚
â”‚                â†“                             â”‚
â”‚  åˆ†æå†³ç­–å±‚                                  â”‚
â”‚   â”œâ”€â”€ ç»Ÿè®¡åˆ†æ                              â”‚
â”‚   â”œâ”€â”€ æ•ˆæœè¯„ä¼°                              â”‚
â”‚   â””â”€â”€ è‡ªåŠ¨å†³ç­–                              â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="52">5.2 åˆ†æµç³»ç»Ÿè®¾è®¡</h3>
<h4 id="_47">åˆ†æµç®—æ³•</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TrafficSplitter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æµé‡åˆ†æµå™¨&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_buckets</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># ç”¨æˆ·åˆ†æ¡¶æ•°</span>

    <span class="k">def</span> <span class="nf">get_user_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—ç”¨æˆ·æ‰€å±æ¡¶&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨MurmurHashä¿è¯åˆ†å¸ƒå‡åŒ€</span>
        <span class="n">hash_value</span> <span class="o">=</span> <span class="n">mmh3</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hash_value</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_buckets</span>

    <span class="k">def</span> <span class="nf">assign_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">experiment_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ†é…å®éªŒç»„&quot;&quot;&quot;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_bucket</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å®éªŒæµé‡ä¸­</span>
        <span class="k">if</span> <span class="n">bucket</span> <span class="o">&lt;</span> <span class="n">experiment_config</span><span class="o">.</span><span class="n">traffic_start</span> <span class="ow">or</span> \
           <span class="n">bucket</span> <span class="o">&gt;=</span> <span class="n">experiment_config</span><span class="o">.</span><span class="n">traffic_end</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;control&#39;</span>  <span class="c1"># å¯¹ç…§ç»„</span>

        <span class="c1"># åœ¨å®éªŒæµé‡ä¸­è¿›ä¸€æ­¥åˆ†ç»„</span>
        <span class="n">exp_bucket</span> <span class="o">=</span> <span class="n">bucket</span> <span class="o">-</span> <span class="n">experiment_config</span><span class="o">.</span><span class="n">traffic_start</span>
        <span class="n">bucket_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">experiment_config</span><span class="o">.</span><span class="n">traffic_end</span> <span class="o">-</span> 
                      <span class="n">experiment_config</span><span class="o">.</span><span class="n">traffic_start</span><span class="p">)</span>

        <span class="c1"># æ ¹æ®é…ç½®æ¯”ä¾‹åˆ†é…åˆ°ä¸åŒå®éªŒç»„</span>
        <span class="n">cumulative</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">experiment_config</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cumulative</span> <span class="o">+=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">bucket_size</span>
            <span class="k">if</span> <span class="n">exp_bucket</span> <span class="o">&lt;</span> <span class="n">cumulative</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">group</span>

        <span class="k">return</span> <span class="s1">&#39;control&#39;</span>
</code></pre></div>

<h4 id="_48">æ­£äº¤å®éªŒæ¡†æ¶</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ­£äº¤å®éªŒè®¾è®¡                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  Layer 1: æ¨èç®—æ³•å®éªŒ                       â”‚
â”‚   â”œâ”€â”€ å®éªŒAï¼šæ–°å¬å›ç­–ç•¥ï¼ˆ10%æµé‡ï¼‰          â”‚
â”‚   â”œâ”€â”€ å®éªŒBï¼šæ’åºæ¨¡å‹v2ï¼ˆ10%æµé‡ï¼‰          â”‚
â”‚   â””â”€â”€ åŸºçº¿ï¼šå½“å‰ç®—æ³•ï¼ˆ80%æµé‡ï¼‰             â”‚
â”‚                                              â”‚
â”‚  Layer 2: UIå®éªŒ                             â”‚
â”‚   â”œâ”€â”€ å®éªŒCï¼šæ–°é¦–é¡µå¸ƒå±€ï¼ˆ20%æµé‡ï¼‰          â”‚
â”‚   â””â”€â”€ åŸºçº¿ï¼šå½“å‰UIï¼ˆ80%æµé‡ï¼‰               â”‚
â”‚                                              â”‚
â”‚  Layer 3: ä¸šåŠ¡ç­–ç•¥å®éªŒ                       â”‚
â”‚   â”œâ”€â”€ å®éªŒDï¼šæ¿€åŠ±ç­–ç•¥ï¼ˆ15%æµé‡ï¼‰            â”‚
â”‚   â””â”€â”€ åŸºçº¿ï¼šæ— æ¿€åŠ±ï¼ˆ85%æµé‡ï¼‰               â”‚
â”‚                                              â”‚
â”‚  æ­£äº¤æ€§ä¿è¯ï¼š                                â”‚
â”‚   â€¢ æ¯å±‚ç‹¬ç«‹åˆ†æµ                            â”‚
â”‚   â€¢ å±‚é—´äº’ä¸å½±å“                            â”‚
â”‚   â€¢ æ”¯æŒ2^nç§ç»„åˆ                           â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="53">5.3 æŒ‡æ ‡ä½“ç³»å»ºè®¾</h3>
<h4 id="_49">æ ¸å¿ƒæŒ‡æ ‡åˆ†ç±»</h4>
<p>| æŒ‡æ ‡ç±»å‹ | å…·ä½“æŒ‡æ ‡ | è®¡ç®—æ–¹æ³• | å†³ç­–æƒé‡ |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡ç±»å‹</th>
<th>å…·ä½“æŒ‡æ ‡</th>
<th>è®¡ç®—æ–¹æ³•</th>
<th>å†³ç­–æƒé‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŒ—ææ˜ŸæŒ‡æ ‡</td>
<td>DAU</td>
<td>æ—¥æ´»è·ƒç”¨æˆ·æ•°</td>
<td>40%</td>
</tr>
<tr>
<td>ç”¨æˆ·ä½“éªŒ</td>
<td>äººå‡ä½¿ç”¨æ—¶é•¿</td>
<td>æ€»æ—¶é•¿/DAU</td>
<td>25%</td>
</tr>
<tr>
<td>å†…å®¹æ¶ˆè´¹</td>
<td>äººå‡æ’­æ”¾é‡</td>
<td>æ€»æ’­æ”¾/DAU</td>
<td>20%</td>
</tr>
<tr>
<td>ç¤¾åŒºäº’åŠ¨</td>
<td>äº’åŠ¨ç‡</td>
<td>äº’åŠ¨ç”¨æˆ·/æ´»è·ƒç”¨æˆ·</td>
<td>10%</td>
</tr>
<tr>
<td>å•†ä¸šåŒ–</td>
<td>ARPU</td>
<td>æ€»æ”¶å…¥/æ´»è·ƒç”¨æˆ·</td>
<td>5%</td>
</tr>
</tbody>
</table>
<h4 id="pipeline_2">æŒ‡æ ‡è®¡ç®—Pipeline</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MetricsCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æŒ‡æ ‡è®¡ç®—å™¨&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">calculate_experiment_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—å®éªŒæŒ‡æ ‡&quot;&quot;&quot;</span>

        <span class="c1"># è·å–å®éªŒç”¨æˆ·</span>
        <span class="n">exp_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_users</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># ç”¨æˆ·è§„æ¨¡æŒ‡æ ‡</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;dau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_users</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="c1"># è¡Œä¸ºæŒ‡æ ‡</span>
        <span class="n">behaviors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_behaviors</span><span class="p">(</span><span class="n">exp_users</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;avg_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behaviors</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">F</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;avg_plays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behaviors</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">F</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s1">&#39;play_count&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># ç•™å­˜æŒ‡æ ‡</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;retention_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_retention</span><span class="p">(</span>
            <span class="n">exp_users</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;retention_7d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_retention</span><span class="p">(</span>
            <span class="n">exp_users</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">7</span>
        <span class="p">)</span>

        <span class="c1"># ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ</span>
        <span class="n">control_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_control_metrics</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistical_test</span><span class="p">(</span>
            <span class="n">metrics</span><span class="p">,</span> <span class="n">control_metrics</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">statistical_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

        <span class="c1"># Tæ£€éªŒ</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span>
            <span class="n">treatment</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">],</span>
            <span class="n">control</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># æ•ˆåº”é‡è®¡ç®—ï¼ˆCohen&#39;s dï¼‰</span>
        <span class="n">effect_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">treatment</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span> <span class="o">/</span> \
                     <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">treatment</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s1">&#39;effect_size&#39;</span><span class="p">:</span> <span class="n">effect_size</span><span class="p">,</span>
            <span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="54">5.4 å®éªŒåˆ†æç³»ç»Ÿ</h3>
<h4 id="_50">è‡ªåŠ¨åŒ–åˆ†ææ¡†æ¶</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å®éªŒåˆ†ææµç¨‹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  æ•°æ®æ”¶é›†ï¼ˆT+0ï¼‰                             â”‚
â”‚   â””â”€â”€ å®æ—¶æŒ‡æ ‡é‡‡é›†                          â”‚
â”‚            â†“                                 â”‚
â”‚  æ•°æ®è´¨é‡æ£€æŸ¥ï¼ˆT+1å°æ—¶ï¼‰                     â”‚
â”‚   â”œâ”€â”€ æ•°æ®å®Œæ•´æ€§æ ¡éªŒ                        â”‚
â”‚   â”œâ”€â”€ å¼‚å¸¸å€¼æ£€æµ‹                            â”‚
â”‚   â””â”€â”€ æ ·æœ¬å¹³è¡¡æ€§æ£€æŸ¥                        â”‚
â”‚            â†“                                 â”‚
â”‚  æŒ‡æ ‡è®¡ç®—ï¼ˆT+2å°æ—¶ï¼‰                         â”‚
â”‚   â”œâ”€â”€ æ ¸å¿ƒæŒ‡æ ‡è®¡ç®—                          â”‚
â”‚   â”œâ”€â”€ åˆ†ç¾¤æŒ‡æ ‡è®¡ç®—                          â”‚
â”‚   â””â”€â”€ æ¼æ–—åˆ†æ                              â”‚
â”‚            â†“                                 â”‚
â”‚  ç»Ÿè®¡åˆ†æï¼ˆT+3å°æ—¶ï¼‰                         â”‚
â”‚   â”œâ”€â”€ æ˜¾è‘—æ€§æ£€éªŒ                            â”‚
â”‚   â”œâ”€â”€ ç½®ä¿¡åŒºé—´è®¡ç®—                          â”‚
â”‚   â””â”€â”€ å¤šé‡æ£€éªŒæ ¡æ­£                          â”‚
â”‚            â†“                                 â”‚
â”‚  æ•ˆæœè¯„ä¼°ï¼ˆT+4å°æ—¶ï¼‰                         â”‚
â”‚   â”œâ”€â”€ æå‡åº¦è®¡ç®—                            â”‚
â”‚   â”œâ”€â”€ åˆ†ç¾¤æ•ˆæœåˆ†æ                          â”‚
â”‚   â””â”€â”€ è´Ÿå‘æŒ‡æ ‡ç›‘æ§                          â”‚
â”‚            â†“                                 â”‚
â”‚  å†³ç­–å»ºè®®ï¼ˆT+6å°æ—¶ï¼‰                         â”‚
â”‚   â””â”€â”€ è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š                          â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="_51">å› æœæ¨æ–­åº”ç”¨</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CausalInference</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å› æœæ¨æ–­åˆ†æ&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">estimate_ate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">confounders</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¼°è®¡å¹³å‡å¤„ç†æ•ˆåº”ï¼ˆATEï¼‰&quot;&quot;&quot;</span>

        <span class="c1"># å€¾å‘å¾—åˆ†åŒ¹é…</span>
        <span class="n">ps_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
        <span class="n">ps_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">confounders</span><span class="p">,</span> <span class="n">treatment</span><span class="p">)</span>
        <span class="n">propensity_scores</span> <span class="o">=</span> <span class="n">ps_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">confounders</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># é€†æ¦‚ç‡åŠ æƒï¼ˆIPWï¼‰</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">treatment</span> <span class="o">/</span> <span class="n">propensity_scores</span> <span class="o">+</span> \
                 <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">treatment</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">propensity_scores</span><span class="p">)</span>

        <span class="c1"># åŠ æƒå›å½’</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">treatment</span><span class="p">,</span> <span class="n">confounders</span><span class="p">]),</span>
            <span class="n">outcome</span><span class="p">,</span>
            <span class="n">sample_weight</span><span class="o">=</span><span class="n">weights</span>
        <span class="p">)</span>

        <span class="c1"># ATE = å¤„ç†ç»„æ•ˆæœ - å¯¹ç…§ç»„æ•ˆæœ</span>
        <span class="n">ate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Bootstrapè®¡ç®—ç½®ä¿¡åŒºé—´</span>
        <span class="n">ate_bootstrap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">treatment</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">treatment</span><span class="p">))</span>
            <span class="n">boot_ate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_ate_single</span><span class="p">(</span>
                <span class="n">treatment</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">outcome</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">confounders</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">ate_bootstrap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boot_ate</span><span class="p">)</span>

        <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">ate_bootstrap</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">ate_bootstrap</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ate&#39;</span><span class="p">:</span> <span class="n">ate</span><span class="p">,</span>
            <span class="s1">&#39;ci_lower&#39;</span><span class="p">:</span> <span class="n">ci_lower</span><span class="p">,</span>
            <span class="s1">&#39;ci_upper&#39;</span><span class="p">:</span> <span class="n">ci_upper</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="55">5.5 å®éªŒæœ€ä½³å®è·µ</h3>
<h4 id="_52">å®éªŒè®¾è®¡åŸåˆ™</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®éªŒè®¾è®¡æ£€æŸ¥æ¸…å•                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  âœ“ æ˜ç¡®å‡è®¾                                 â”‚
â”‚    â€¢ å®éªŒç›®æ ‡æ¸…æ™°                           â”‚
â”‚    â€¢ æˆåŠŸæŒ‡æ ‡å®šä¹‰                           â”‚
â”‚    â€¢ é¢„æœŸæ•ˆæœé‡                             â”‚
â”‚                                              â”‚
â”‚  âœ“ æ ·æœ¬é‡è®¡ç®—                               â”‚
â”‚    â€¢ ç»Ÿè®¡åŠŸæ•ˆ &gt; 80%                         â”‚
â”‚    â€¢ æ˜¾è‘—æ€§æ°´å¹³ = 0.05                      â”‚
â”‚    â€¢ æœ€å°å¯æ£€æµ‹æ•ˆåº”ï¼ˆMDEï¼‰                  â”‚
â”‚                                              â”‚
â”‚  âœ“ éšæœºåŒ–è®¾è®¡                               â”‚
â”‚    â€¢ åˆ†ç»„éšæœºæ€§                             â”‚
â”‚    â€¢ æ ·æœ¬å¹³è¡¡æ€§                             â”‚
â”‚    â€¢ é¿å…æº¢å‡ºæ•ˆåº”                           â”‚
â”‚                                              â”‚
â”‚  âœ“ å®éªŒå‘¨æœŸ                                 â”‚
â”‚    â€¢ æœ€çŸ­ï¼š1å‘¨ï¼ˆå¿«é€Ÿè¿­ä»£ï¼‰                  â”‚
â”‚    â€¢ æ ‡å‡†ï¼š2å‘¨ï¼ˆå¸¸è§„å®éªŒï¼‰                  â”‚
â”‚    â€¢ é•¿æœŸï¼š4å‘¨+ï¼ˆé‡å¤§æ”¹åŠ¨ï¼‰                 â”‚
â”‚                                              â”‚
â”‚  âœ“ é£é™©æ§åˆ¶                                 â”‚
â”‚    â€¢ é™çº§æ–¹æ¡ˆ                               â”‚
â”‚    â€¢ å®æ—¶ç›‘æ§                               â”‚
â”‚    â€¢ å¿«é€Ÿæ­¢æŸ                               â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="_53">å…¸å‹å®éªŒæ¡ˆä¾‹</h4>
<h5 id="1">æ¡ˆä¾‹1ï¼šæ¨èç®—æ³•ä¼˜åŒ–</h5>
<p>| ç»´åº¦ | è¯¦æƒ… |</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>è¯¦æƒ…</th>
</tr>
</thead>
<tbody>
<tr>
<td>èƒŒæ™¯</td>
<td>CTRå¢é•¿æ”¾ç¼“ï¼Œéœ€è¦ç®—æ³•çªç ´</td>
</tr>
<tr>
<td>å‡è®¾</td>
<td>å¼•å…¥Transformerèƒ½æå‡æ¨èæ•ˆæœ</td>
</tr>
<tr>
<td>å®éªŒè®¾è®¡</td>
<td>10%æµé‡ï¼Œè¿è¡Œ14å¤©</td>
</tr>
<tr>
<td>ç»“æœ</td>
<td>CTR +3.2%, äººå‡æ—¶é•¿ +5.1%</td>
</tr>
<tr>
<td>å†³ç­–</td>
<td>å…¨é‡ä¸Šçº¿ï¼Œç»§ç»­ä¼˜åŒ–</td>
</tr>
</tbody>
</table>
<h5 id="2ui">æ¡ˆä¾‹2ï¼šUIæ”¹ç‰ˆæµ‹è¯•</h5>
<p>| ç»´åº¦ | è¯¦æƒ… |</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>è¯¦æƒ…</th>
</tr>
</thead>
<tbody>
<tr>
<td>èƒŒæ™¯</td>
<td>é¦–é¡µä¿¡æ¯å¯†åº¦è¿‡é«˜</td>
</tr>
<tr>
<td>å‡è®¾</td>
<td>ç®€åŒ–å¸ƒå±€èƒ½æå‡ç”¨æˆ·ä½“éªŒ</td>
</tr>
<tr>
<td>å®éªŒè®¾è®¡</td>
<td>20%æµé‡ï¼Œè¿è¡Œ21å¤©</td>
</tr>
<tr>
<td>ç»“æœ</td>
<td>ç•™å­˜ç‡ +1.5%, ä½†æ—¶é•¿ -2%</td>
</tr>
<tr>
<td>å†³ç­–</td>
<td>éƒ¨åˆ†é‡‡çº³ï¼Œä¿ç•™æ ¸å¿ƒæ”¹åŠ¨</td>
</tr>
</tbody>
</table>
<h4 id="_54">å®éªŒæ–‡åŒ–å»ºè®¾</h4>
<div class="codehilite"><pre><span></span><code>Bç«™å®éªŒæ–‡åŒ–æ ¸å¿ƒç†å¿µï¼š

1. æ•°æ®é©±åŠ¨ï¼ˆData-Drivenï¼‰
   â€¢ ä¸€åˆ‡ä»¥æ•°æ®è¯´è¯
   â€¢ æ‹’ç»æ‹è„‘è¢‹å†³ç­–

2. å¿«é€Ÿè¿­ä»£ï¼ˆFail Fastï¼‰
   â€¢ å°æ­¥å¿«è·‘
   â€¢ åŠæ—¶æ­¢æŸ

3. ç§‘å­¦ä¸¥è°¨ï¼ˆScientificï¼‰
   â€¢ ç»Ÿè®¡æ˜¾è‘—æ€§
   â€¢ å› æœå…³ç³»éªŒè¯

4. å…¨å‘˜å‚ä¸ï¼ˆInclusiveï¼‰
   â€¢ äº§å“æå‡è®¾
   â€¢ æŠ€æœ¯åšå®éªŒ
   â€¢ è¿è¥çœ‹æ•°æ®

5. æŒç»­ä¼˜åŒ–ï¼ˆContinuousï¼‰
   â€¢ å¤ç›˜æ€»ç»“
   â€¢ çŸ¥è¯†æ²‰æ·€
</code></pre></div>

<hr />
            </article>
            
            <nav class="page-nav"><a href="chapter8.html" class="nav-link prev">â† ç¬¬8ç« ï¼šè§†é¢‘æŠ€æœ¯æ¶æ„</a><a href="chapter10.html" class="nav-link next">ç¬¬10ç« ï¼šç›´æ’­æŠ€æœ¯ä½“ç³» â†’</a></nav>
        </main>
    </div>
</body>
</html>