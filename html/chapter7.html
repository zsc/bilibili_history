<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬7ç« ï¼šå¼¹å¹•ç³»ç»Ÿæ¼”è¿›å²</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Bç«™æŠ€æœ¯å‘å±•å²ï¼šä»å¼¹å¹•ç½‘ç«™åˆ°ç»¼åˆæ€§å†…å®¹å¹³å°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šåˆ›ä¸–çºªï¼ˆ2009-2011ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šæˆé•¿æœŸï¼ˆ2012-2014ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šç§»åŠ¨è½¬å‹ï¼ˆ2015-2017ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè§„æ¨¡åŒ–æ‰©å¼ ï¼ˆ2018-2020ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šæŠ€æœ¯æ·±è€•ï¼ˆ2021-2023ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šAIæ—¶ä»£ï¼ˆ2024-è‡³ä»Šï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå¼¹å¹•ç³»ç»Ÿæ¼”è¿›å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè§†é¢‘æŠ€æœ¯æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šæ¨èç³»ç»Ÿä¸ç®—æ³•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šç›´æ’­æŠ€æœ¯ä½“ç³»</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šåŸºç¡€è®¾æ–½å»ºè®¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šæŠ€æœ¯ç»„ç»‡ä¸æ–‡åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="7">ç¬¬7ç« ï¼šå¼¹å¹•ç³»ç»Ÿæ¼”è¿›å²</h1>
<blockquote>
<p>ä»XMLæ–‡ä»¶åˆ°äº‘åŸç”ŸæœåŠ¡ï¼šBç«™å¼¹å¹•æŠ€æœ¯15å¹´æ¼”è¿›ä¹‹è·¯</p>
</blockquote>
<h2 id="_1">æ¦‚è¿°</h2>
<p>å¼¹å¹•ï¼ˆDanmaku/Barrageï¼‰ä½œä¸ºBç«™çš„æ ¸å¿ƒç‰¹è‰²åŠŸèƒ½ï¼Œä¸ä»…å®šä¹‰äº†å¹³å°çš„æ–‡åŒ–åŸºå› ï¼Œæ›´æˆä¸ºäº†ä¸­å›½äº’è”ç½‘è§†é¢‘äº¤äº’çš„æ ‡å¿—æ€§åˆ›æ–°ã€‚ä»2009å¹´ç®€å•çš„XMLæ–‡ä»¶å­˜å‚¨ï¼Œåˆ°2024å¹´æ”¯æ’‘æ¯æ—¥æ•°äº¿æ¡å¼¹å¹•çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒBç«™å¼¹å¹•æŠ€æœ¯ç»å†äº†å¤šæ¬¡æ¶æ„é©å‘½ã€‚</p>
<p>æœ¬ç« å°†æ·±å…¥å‰–æå¼¹å¹•ç³»ç»Ÿçš„æŠ€æœ¯æ¼”è¿›å†ç¨‹ï¼Œæ­ç¤ºå…¶èƒŒåçš„æ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œåˆ›æ–°çªç ´ã€‚</p>
<h2 id="_2">å¼¹å¹•ç³»ç»Ÿæ¶æ„æ¼”è¿›æ—¶é—´çº¿</h2>
<div class="codehilite"><pre><span></span><code><span class="mf">2009</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="mf">2024</span>
<span class="w"> </span><span class="err">â”‚</span><span class="w">                                                                      </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2009.06</span><span class="err">]</span><span class="w"> </span><span class="n">XMLæ–‡ä»¶å­˜å‚¨</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Flashæ’­æ”¾å™¨</span><span class="w">                                  </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2010.03</span><span class="err">]</span><span class="w"> </span><span class="n">å¼•å…¥å¼¹å¹•æ± æ¦‚å¿µ</span><span class="err">ï¼Œ</span><span class="n">é™åˆ¶å•è§†é¢‘å¼¹å¹•ä¸Šé™</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2012.01</span><span class="err">]</span><span class="w"> </span><span class="n">è¿ç§»è‡³MySQL</span><span class="err">ï¼Œ</span><span class="n">æ”¯æŒå¼¹å¹•æ£€ç´¢</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2013.07</span><span class="err">]</span><span class="w"> </span><span class="n">å¼¹å¹•ä¸¾æŠ¥ä¸å®¡æ ¸ç³»ç»Ÿä¸Šçº¿</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2015.04</span><span class="err">]</span><span class="w"> </span><span class="n">Redisç¼“å­˜å±‚</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">è¯»å†™åˆ†ç¦»</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2016.11</span><span class="err">]</span><span class="w"> </span><span class="n">å¼¹å¹•å®æ—¶æ¨é€WebSocketé•¿è¿æ¥</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2018.05</span><span class="err">]</span><span class="w"> </span><span class="n">åˆ†å¸ƒå¼å­˜å‚¨æ¶æ„</span><span class="err">ï¼Œ</span><span class="n">HBaseå¼•å…¥</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2019.09</span><span class="err">]</span><span class="w"> </span><span class="n">è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²</span><span class="err">ï¼Œ</span><span class="n">CDNå¼¹å¹•åŠ é€Ÿ</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2020.12</span><span class="err">]</span><span class="w"> </span><span class="n">å®æ—¶è®¡ç®—å¹³å°</span><span class="err">ï¼Œ</span><span class="n">Flinkæµå¤„ç†</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2022.03</span><span class="err">]</span><span class="w"> </span><span class="n">äº‘åŸç”Ÿæ”¹é€ </span><span class="err">ï¼Œ</span><span class="n">å®¹å™¨åŒ–éƒ¨ç½²</span><span class="w">                                    </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â”œâ”€[</span><span class="mf">2023.06</span><span class="err">]</span><span class="w"> </span><span class="n">AIå¼¹å¹•è¿‡æ»¤ä¸æ™ºèƒ½æ¨è</span><span class="w">                                      </span><span class="err">â”‚</span>
<span class="w"> </span><span class="err">â””â”€[</span><span class="mf">2024.01</span><span class="err">]</span><span class="w"> </span><span class="n">å¤šæ¨¡æ€å¼¹å¹•</span><span class="err">ï¼Œ</span><span class="n">æ”¯æŒè¡¨æƒ…</span><span class="err">ã€</span><span class="n">è´´çº¸</span><span class="w">                                </span><span class="err">â”‚</span>
</code></pre></div>

<h2 id="xml2009-2011">ç¬¬ä¸€ä»£ï¼šXMLæ–‡ä»¶æ—¶ä»£ï¼ˆ2009-2011ï¼‰</h2>
<h3 id="_3">æŠ€æœ¯èƒŒæ™¯</h3>
<p>2009å¹´6æœˆï¼Œå¾é€¸åœ¨åˆ›å»ºBilibiliæ—¶ï¼Œå‚è€ƒäº†æ—¥æœ¬NiconicoåŠ¨ç”»çš„å¼¹å¹•è®¾è®¡ï¼Œä½†é‡‡ç”¨äº†å®Œå…¨ä¸åŒçš„æŠ€æœ¯å®ç°è·¯å¾„ã€‚å½“æ—¶çš„æŠ€æœ¯ç¯å¢ƒï¼š</p>
<ul>
<li><strong>æœåŠ¡å™¨é…ç½®</strong>ï¼šå•å°é˜¿é‡Œäº‘ECSï¼Œ2æ ¸4Gå†…å­˜ï¼Œ100GBç¡¬ç›˜</li>
<li><strong>æœˆåº¦æˆæœ¬</strong>ï¼šçº¦Â¥800ï¼ˆæœåŠ¡å™¨ï¼‰ + Â¥200ï¼ˆå¸¦å®½ï¼‰</li>
<li><strong>å¼€å‘å›¢é˜Ÿ</strong>ï¼šå¾é€¸1äºº + 2åå…¼èŒå¼€å‘è€…</li>
<li><strong>åˆå§‹ç”¨æˆ·</strong>ï¼šæ—¥æ´»çº¦500äººï¼Œä¸»è¦æ¥è‡ªAcFun</li>
<li><strong>æŠ€æœ¯æ ˆé€‰æ‹©</strong>ï¼šPHP 5.2 + Apache 2.2 + æ–‡ä»¶ç³»ç»Ÿ</li>
</ul>
<h3 id="_4">æ—©æœŸæ¶æ„å†³ç­–</h3>
<p>å¾é€¸åœ¨æŠ€æœ¯é€‰å‹æ—¶é¢ä¸´çš„æƒè¡¡ï¼š</p>
<p>| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | æœ€ç»ˆé€‰æ‹©ç†ç”± |</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
<th>æœ€ç»ˆé€‰æ‹©ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQLå­˜å‚¨</td>
<td>ç»“æ„åŒ–æŸ¥è¯¢</td>
<td>éœ€è¦é¢å¤–å­¦ä¹ æˆæœ¬</td>
<td>åˆæœŸç”¨æˆ·å°‘ï¼Œè¿‡åº¦è®¾è®¡</td>
</tr>
<tr>
<td>XMLæ–‡ä»¶</td>
<td>ç®€å•ç›´æ¥ï¼Œæ˜“è°ƒè¯•</td>
<td>å¹¶å‘æ€§èƒ½å·®</td>
<td>âœ“ å¿«é€Ÿä¸Šçº¿ï¼ŒMVPæ€ç»´</td>
</tr>
<tr>
<td>JSONæ–‡ä»¶</td>
<td>ä½“ç§¯æ›´å°</td>
<td>Flashè§£æå¤æ‚</td>
<td>XMLä¸FlashåŸç”Ÿå…¼å®¹</td>
</tr>
<tr>
<td>å†…å­˜ç¼“å­˜</td>
<td>æ€§èƒ½æœ€ä¼˜</td>
<td>æŒä¹…åŒ–å¤æ‚</td>
<td>æˆæœ¬è¿‡é«˜</td>
</tr>
</tbody>
</table>
<h3 id="_5">ç³»ç»Ÿæ¶æ„</h3>
<div class="codehilite"><pre><span></span><code><span class="n">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="n">â”‚              ç”¨æˆ·æµè§ˆå™¨                        â”‚</span>
<span class="n">â”‚         Flash Player + AS3è„šæœ¬                â”‚</span>
<span class="n">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="n">                 â”‚ HTTPè¯·æ±‚</span>
<span class="n">                 â†“</span>
<span class="n">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="n">â”‚            ApacheæœåŠ¡å™¨                       â”‚</span>
<span class="n">â”‚         PHP 5.2 å¤„ç†é€»è¾‘                      â”‚</span>
<span class="n">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="n">                 â”‚ æ–‡ä»¶è¯»å†™</span>
<span class="n">                 â†“</span>
<span class="n">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="n">â”‚          æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨                         â”‚</span>
<span class="n">â”‚   /danmaku/{video_id}.xml                    â”‚</span>
<span class="n">â”‚   æ¯ä¸ªè§†é¢‘å¯¹åº”ä¸€ä¸ªXMLæ–‡ä»¶                     â”‚</span>
<span class="n">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="xml">XMLæ•°æ®ç»“æ„</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;i&gt;</span>
<span class="w">    </span><span class="nt">&lt;chatserver&gt;</span>chat.bilibili.com<span class="nt">&lt;/chatserver&gt;</span>
<span class="w">    </span><span class="nt">&lt;chatid&gt;</span>10000<span class="nt">&lt;/chatid&gt;</span>
<span class="w">    </span><span class="nt">&lt;mission&gt;</span>0<span class="nt">&lt;/mission&gt;</span>
<span class="w">    </span><span class="nt">&lt;maxlimit&gt;</span>1000<span class="nt">&lt;/maxlimit&gt;</span>
<span class="w">    </span><span class="nt">&lt;d</span><span class="w"> </span><span class="na">p=</span><span class="s">&quot;23.826,1,25,16777215,1312863038,0,eff85b3,42398483&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>è¿™æ˜¯ä¸€æ¡å¼¹å¹•å†…å®¹
<span class="w">    </span><span class="nt">&lt;/d&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- på‚æ•°è¯´æ˜ï¼š</span>
<span class="cm">         æ—¶é—´,æ¨¡å¼,å­—å·,é¢œè‰²,æ—¶é—´æˆ³,å¼¹å¹•æ± ,ç”¨æˆ·hash,å¼¹å¹•id --&gt;</span>
<span class="nt">&lt;/i&gt;</span>
</code></pre></div>

<h3 id="_6">å…³é”®æŠ€æœ¯ç‰¹ç‚¹</h3>
<p>| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>å®ç°æ–¹å¼</th>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­˜å‚¨</td>
<td>XMLå¹³æ–‡ä»¶</td>
<td>ç®€å•ç›´æ¥</td>
<td>å¹¶å‘å†™å…¥å†²çª</td>
</tr>
<tr>
<td>è¯»å–</td>
<td>å…¨é‡åŠ è½½</td>
<td>å®ç°ç®€å•</td>
<td>å¤§æ–‡ä»¶æ€§èƒ½å·®</td>
</tr>
<tr>
<td>æ¸²æŸ“</td>
<td>Flash AS3</td>
<td>è·¨æµè§ˆå™¨</td>
<td>ç§»åŠ¨ç«¯ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>åŒæ­¥</td>
<td>è½®è¯¢æœºåˆ¶</td>
<td>æ˜“äºå®ç°</td>
<td>å®æ—¶æ€§å·®</td>
</tr>
</tbody>
</table>
<h3 id="php">PHPå¤„ç†é€»è¾‘å®ç°</h3>
<div class="codehilite"><pre><span></span><code><span class="x">// danmaku.php - æ—©æœŸå¼¹å¹•å¤„ç†æ ¸å¿ƒä»£ç </span>
<span class="x">class DanmakuHandler {</span>
<span class="x">    private $baseDir = &#39;/var/www/danmaku/&#39;;</span>
<span class="x">    private $maxDanmaku = 1000; // å•è§†é¢‘å¼¹å¹•ä¸Šé™</span>

<span class="x">    public function loadDanmaku($videoId) {</span>
<span class="x">        $filePath = $this-&gt;baseDir . $videoId . &#39;.xml&#39;;</span>
<span class="x">        if (!file_exists($filePath)) {</span>
<span class="x">            return $this-&gt;createEmptyXML();</span>
<span class="x">        }</span>

<span class="x">        // æ–‡ä»¶é”ï¼Œé˜²æ­¢è¯»å†™å†²çª</span>
<span class="x">        $fp = fopen($filePath, &#39;r&#39;);</span>
<span class="x">        flock($fp, LOCK_SH);</span>
<span class="x">        $content = fread($fp, filesize($filePath));</span>
<span class="x">        flock($fp, LOCK_UN);</span>
<span class="x">        fclose($fp);</span>

<span class="x">        return $content;</span>
<span class="x">    }</span>

<span class="x">    public function addDanmaku($videoId, $params) {</span>
<span class="x">        $filePath = $this-&gt;baseDir . $videoId . &#39;.xml&#39;;</span>

<span class="x">        // è§£æå‚æ•°ï¼šæ—¶é—´,æ¨¡å¼,å­—å·,é¢œè‰²,æ—¶é—´æˆ³,å¼¹å¹•æ± ,ç”¨æˆ·hash</span>
<span class="x">        $p = sprintf(&quot;%.3f,%d,%d,%d,%d,0,%s,%d&quot;,</span>
<span class="x">            $params[&#39;time&#39;],</span>
<span class="x">            $params[&#39;mode&#39;],</span>
<span class="x">            $params[&#39;size&#39;],</span>
<span class="x">            $params[&#39;color&#39;],</span>
<span class="x">            time(),</span>
<span class="x">            substr(md5($params[&#39;user_ip&#39;]), 0, 8),</span>
<span class="x">            $this-&gt;getNextId($videoId)</span>
<span class="x">        );</span>

<span class="x">        $danmakuNode = sprintf(</span>
<span class="x">            &#39;    &lt;d p=&quot;%s&quot;&gt;%s&lt;/d&gt;&#39; . PHP_EOL,</span>
<span class="x">            $p,</span>
<span class="x">            htmlspecialchars($params[&#39;text&#39;])</span>
<span class="x">        );</span>

<span class="x">        // ä½¿ç”¨æ–‡ä»¶é”è¿›è¡Œå†™å…¥</span>
<span class="x">        $fp = fopen($filePath, &#39;r+&#39;);</span>
<span class="x">        flock($fp, LOCK_EX);</span>

<span class="x">        // è¯»å–ç°æœ‰å†…å®¹</span>
<span class="x">        $content = fread($fp, filesize($filePath));</span>
<span class="x">        $lines = explode(&quot;\n&quot;, $content);</span>

<span class="x">        // æ£€æŸ¥å¼¹å¹•æ•°é‡é™åˆ¶</span>
<span class="x">        $danmakuCount = substr\_count($content, &#39;&lt;d &#39;);</span>
<span class="x">        if ($danmakuCount &gt;= $this-&gt;maxDanmaku) {</span>
<span class="x">            flock($fp, LOCK_UN);</span>
<span class="x">            fclose($fp);</span>
<span class="x">            return false;</span>
<span class="x">        }</span>

<span class="x">        // æ’å…¥æ–°å¼¹å¹•ï¼ˆåœ¨&lt;/i&gt;æ ‡ç­¾å‰ï¼‰</span>
<span class="x">        $insertPos = count($lines) - 2;</span>
<span class="x">        array_splice($lines, $insertPos, 0, $danmakuNode);</span>

<span class="x">        // å†™å›æ–‡ä»¶</span>
<span class="x">        fseek($fp, 0);</span>
<span class="x">        ftruncate($fp, 0);</span>
<span class="x">        fwrite($fp, implode(&quot;\n&quot;, $lines));</span>
<span class="x">        flock($fp, LOCK_UN);</span>
<span class="x">        fclose($fp);</span>

<span class="x">        return true;</span>
<span class="x">    }</span>
<span class="x">}</span>
</code></pre></div>

<h3 id="_7">æ€§èƒ½ç“¶é¢ˆä¸è§£å†³å°è¯•</h3>
<h4 id="_8">é‡åˆ°çš„é—®é¢˜</h4>
<ul>
<li><strong>æ–‡ä»¶é”é—®é¢˜</strong>ï¼šå¤šç”¨æˆ·åŒæ—¶å‘é€å¼¹å¹•æ—¶çš„å†™å…¥å†²çª</li>
<li>ç—‡çŠ¶ï¼šé«˜å³°æœŸå¼¹å¹•å‘é€å¤±è´¥ç‡è¾¾30%</li>
<li>
<p>ä¸´æ—¶æ–¹æ¡ˆï¼šå®ç°é‡è¯•æœºåˆ¶ï¼Œæœ€å¤šé‡è¯•3æ¬¡</p>
</li>
<li>
<p><strong>å†…å­˜å ç”¨</strong>ï¼šçƒ­é—¨è§†é¢‘XMLæ–‡ä»¶å¯èƒ½è¾¾åˆ°æ•°MB</p>
</li>
<li>ç—‡çŠ¶ï¼šPHPå†…å­˜é™åˆ¶ç»å¸¸è§¦å‘ï¼ˆmemory_limit = 128Mï¼‰</li>
<li>
<p>ä¸´æ—¶æ–¹æ¡ˆï¼šåŠ¨æ€è°ƒæ•´memory_limitï¼Œåˆ†æ‰¹åŠ è½½</p>
</li>
<li>
<p><strong>åŠ è½½æ—¶é—´</strong>ï¼šå¼¹å¹•è¶…è¿‡1000æ¡åæ˜æ˜¾å¡é¡¿</p>
</li>
<li>ç—‡çŠ¶ï¼šFlashæ’­æ”¾å™¨åŠ è½½æ—¶é—´è¶…è¿‡5ç§’</li>
<li>ä¸´æ—¶æ–¹æ¡ˆï¼šå®ç°å¼¹å¹•åˆ†é¡µï¼Œæ¯é¡µ500æ¡</li>
</ul>
<h4 id="flash">Flashå®¢æˆ·ç«¯ä¼˜åŒ–</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// DanmakuPlayer.as - Flashå¼¹å¹•æ’­æ”¾å™¨æ ¸å¿ƒ</span>
<span class="kd">package</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">import</span><span class="w"> </span><span class="nx">flash</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nb">Sprite</span><span class="o">;</span>
<span class="w">    </span><span class="kd">import</span><span class="w"> </span><span class="nx">flash</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nb">Event</span><span class="o">;</span>
<span class="w">    </span><span class="kd">import</span><span class="w"> </span><span class="nx">flash</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nb">URLLoader</span><span class="o">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DanmakuPlayer</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="nb">Sprite</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="nx">danmakuPool</span><span class="o">:</span><span class="nb">Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="nx">activeDanmaku</span><span class="o">:</span><span class="nb">Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="nx">lastFrameTime</span><span class="o">:</span><span class="nb">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>

<span class="w">        </span><span class="c1">// å¯¹è±¡æ± ä¼˜åŒ–ï¼Œå‡å°‘GCå‹åŠ›</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getDanmakuSprite</span><span class="p">()</span><span class="o">:</span><span class="nx">DanmakuSprite</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">danmakuPool</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">danmakuPool</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nx">DanmakuSprite</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">recycleDanmaku</span><span class="p">(</span><span class="nx">sprite</span><span class="o">:</span><span class="nx">DanmakuSprite</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">sprite</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">            </span><span class="nx">danmakuPool</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sprite</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// åˆ†å¸§æ¸²æŸ“ï¼Œé¿å…å¡é¡¿</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onEnterFrame</span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="nb">Event</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="nx">currentTime</span><span class="o">:</span><span class="nb">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">getTimer</span><span class="p">();</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="nx">deltaTime</span><span class="o">:</span><span class="nb">Number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">lastFrameTime</span><span class="o">;</span>

<span class="w">            </span><span class="c1">// é™åˆ¶æ¯å¸§å¤„ç†çš„å¼¹å¹•æ•°é‡</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="nx">processed</span><span class="o">:</span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="nx">maxPerFrame</span><span class="o">:</span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="o">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="nx">danmaku</span><span class="o">:</span><span class="nx">DanmakuSprite</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">activeDanmaku</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">processed</span><span class="o">++</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">maxPerFrame</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="o">;</span>

<span class="w">                </span><span class="nx">danmaku</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">danmaku</span><span class="p">.</span><span class="nx">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">deltaTime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="o">;</span>

<span class="w">                </span><span class="c1">// è¶…å‡ºå±å¹•å›æ”¶</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">danmaku</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="nx">danmaku</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">danmaku</span><span class="p">);</span>
<span class="w">                    </span><span class="nx">recycleDanmaku</span><span class="p">(</span><span class="nx">danmaku</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">lastFrameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span><span class="o">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_9">ç¬¬ä¸€ä»£æ¶æ„çš„å†å²æ„ä¹‰</h3>
<p>å°½ç®¡æŠ€æœ¯ç®€é™‹ï¼Œä½†ç¬¬ä¸€ä»£å¼¹å¹•ç³»ç»Ÿå¥ å®šäº†å‡ ä¸ªé‡è¦åŸºç¡€ï¼š</p>
<ol>
<li><strong>å¼¹å¹•æ–‡åŒ–åŸºå› </strong>ï¼šç¡®ç«‹äº†"åŒæ­¥è§‚çœ‹"çš„æ ¸å¿ƒä½“éªŒ</li>
<li><strong>æŠ€æœ¯å€ºåŠ¡æ„è¯†</strong>ï¼šå¾é€¸åœ¨ä»£ç æ³¨é‡Šä¸­å†™é“"// TODO: ç”¨æˆ·å¤šäº†è¦æ”¹æ•°æ®åº“"</li>
<li><strong>ç”¨æˆ·åé¦ˆå¾ªç¯</strong>ï¼šå»ºç«‹äº†å¿«é€Ÿè¿­ä»£çš„å¼€å‘æ–‡åŒ–</li>
<li><strong>ç¤¾åŒºé©±åŠ¨</strong>ï¼šæ—©æœŸç”¨æˆ·ç›´æ¥å‚ä¸åŠŸèƒ½è®¾è®¡</li>
</ol>
<h2 id="mysql2012-2014">ç¬¬äºŒä»£ï¼šMySQLæ•°æ®åº“æ—¶ä»£ï¼ˆ2012-2014ï¼‰</h2>
<h3 id="_10">å‡çº§åŠ¨å› </h3>
<p>2011å¹´åº•ï¼ŒBç«™æ—¥æ´»è·ƒç”¨æˆ·çªç ´10ä¸‡ï¼Œå•ä¸ªçƒ­é—¨è§†é¢‘å¼¹å¹•æ•°é‡ç»å¸¸è¶…è¿‡5000æ¡ï¼ŒXMLæ–‡ä»¶ç³»ç»Ÿå·²æ— æ³•æ”¯æ’‘ã€‚</p>
<h4 id="_11">å…³é”®å†³ç­–æ—¶åˆ»</h4>
<p>2011å¹´11æœˆçš„ä¸€æ¬¡æœåŠ¡å™¨å®•æœºäº‹ä»¶æˆä¸ºè½¬æŠ˜ç‚¹ï¼š</p>
<ul>
<li><strong>äº‹ä»¶èµ·å› </strong>ï¼šã€ŠFate/Zeroã€‹ç¬¬ä¸€é›†ä¸Šçº¿ï¼Œ1å°æ—¶å†…å¼¹å¹•æ•°é‡è¶…è¿‡8000æ¡</li>
<li><strong>ç³»ç»Ÿå´©æºƒ</strong>ï¼šApacheè¿›ç¨‹å ç”¨100% CPUï¼ŒæœåŠ¡å™¨æ— å“åº”</li>
<li><strong>å½±å“èŒƒå›´</strong>ï¼šæŒç»­å®•æœº3å°æ—¶ï¼Œæµå¤±ç”¨æˆ·çº¦2000äºº</li>
<li><strong>å¾é€¸å†³å®š</strong>ï¼š"å¿…é¡»é‡æ„ï¼Œä¸èƒ½å†ç”¨æ–‡ä»¶äº†"</li>
</ul>
<h3 id="_12">æŠ€æœ¯é€‰å‹è¿‡ç¨‹</h3>
<p>å›¢é˜Ÿè¯„ä¼°äº†å¤šç§æ–¹æ¡ˆï¼š</p>
<p>| æ–¹æ¡ˆ | è¯„ä¼°ç»“æœ | å†³ç­– |</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>è¯„ä¼°ç»“æœ</th>
<th>å†³ç­–</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL</td>
<td>åŠŸèƒ½å¼ºå¤§ä½†å­¦ä¹ æˆæœ¬é«˜</td>
<td>âœ—</td>
</tr>
<tr>
<td>MongoDB</td>
<td>NoSQLé€‚åˆå¼¹å¹•ä½†ç¤¾åŒºæ”¯æŒå°‘</td>
<td>âœ—</td>
</tr>
<tr>
<td>MySQL</td>
<td>æˆç†Ÿç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œ</td>
<td>âœ“</td>
</tr>
<tr>
<td>Redis</td>
<td>ä»…åšç¼“å­˜ï¼Œä¸é€‚åˆæŒä¹…åŒ–</td>
<td>éƒ¨åˆ†é‡‡ç”¨</td>
</tr>
</tbody>
</table>
<h3 id="_13">æ•°æ®åº“æ¶æ„è®¾è®¡</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">-- å¼¹å¹•ä¸»è¡¨</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">danmaku</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">video_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;è§†é¢‘ID&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">user_hash</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;ç”¨æˆ·æ ‡è¯†&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;å¼¹å¹•å†…å®¹&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="w"> </span><span class="nb">decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;å‡ºç°æ—¶é—´&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="k">mode</span><span class="o">`</span><span class="w"> </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;å¼¹å¹•æ¨¡å¼&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">fontsize</span><span class="o">`</span><span class="w"> </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;25&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;å­—ä½“å¤§å°&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">color</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;16777215&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;é¢œè‰²&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">create_time</span><span class="o">`</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;å‘é€æ—¶é—´&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">status</span><span class="o">`</span><span class="w"> </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;çŠ¶æ€&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">idx_video_time</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">video_id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">idx_create_time</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">create_time</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span>

<span class="c1">-- å¼¹å¹•ä¸¾æŠ¥è¡¨</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">danmaku_report</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">danmaku_id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">reporter_hash</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">reason</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">`</span><span class="n">report_time</span><span class="o">`</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">idx_danmaku</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">danmaku_id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span>
</code></pre></div>

<h3 id="_14">æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3>
<h4 id="1">1. åˆ†è¡¨ç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code><span class="x">// åˆ†è¡¨è·¯ç”±å®ç°</span>
<span class="x">class DanmakuSharding {</span>
<span class="x">    private $tableCount = 32;</span>

<span class="x">    public function getTableName($videoId) {</span>
<span class="x">        $hash = crc32($videoId);</span>
<span class="x">        $tableIndex = $hash % $this-&gt;tableCount;</span>
<span class="x">        return sprintf(&#39;danmaku_%02d&#39;, $tableIndex);</span>
<span class="x">    }</span>

<span class="x">    public function queryDanmaku($videoId, $startTime = 0, $endTime = PHP_INT_MAX) {</span>
<span class="x">        $table = $this-&gt;getTableName($videoId);</span>

<span class="x">        $sql = &quot;SELECT \* FROM {$table} </span>
<span class="x">                WHERE video_id = ? </span>
<span class="x">                AND time BETWEEN ? AND ?</span>
<span class="x">                ORDER BY time ASC</span>
<span class="x">                LIMIT 1000&quot;;</span>

<span class="x">        return $this-&gt;db-&gt;query($sql, [$videoId, $startTime, $endTime]);</span>
<span class="x">    }</span>
<span class="x">}</span>
</code></pre></div>

<h4 id="2">2. ç´¢å¼•ä¼˜åŒ–ç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- æ ¸å¿ƒç´¢å¼•è®¾è®¡</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">danmaku_XX</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_video_time</span><span class="w"> </span><span class="p">(</span><span class="n">video_id</span><span class="p">,</span><span class="w"> </span><span class="k">time</span><span class="p">);</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">danmaku_XX</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_video_status_time</span><span class="w"> </span><span class="p">(</span><span class="n">video_id</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="k">time</span><span class="p">);</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">danmaku_XX</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_create_time</span><span class="w"> </span><span class="p">(</span><span class="n">create_time</span><span class="p">);</span>

<span class="c1">-- ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡</span>
<span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">index_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">usage_count</span><span class="p">,</span>
<span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">query_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_time</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">slow_log</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">query_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">index_name</span><span class="p">;</span>
</code></pre></div>

<h4 id="3">3. è¿æ¥æ± é…ç½®</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">; PHP-FPMè¿æ¥æ± é…ç½®</span>
<span class="k">[www]</span>
<span class="na">pm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">dynamic</span>
<span class="na">pm.max_children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">50</span>
<span class="na">pm.start_servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10</span>
<span class="na">pm.min_spare_servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">5</span>
<span class="na">pm.max_spare_servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">20</span>
<span class="na">pm.max_requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">500</span>

<span class="c1">; MySQLæŒä¹…è¿æ¥</span>
<span class="na">mysql.allow_persistent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">On</span>
<span class="na">mysql.max_persistent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">20</span>
<span class="na">mysql.max_links</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">20</span>
</code></pre></div>

<h4 id="4">4. æŸ¥è¯¢ä¼˜åŒ–å®è·µ</h4>
<div class="codehilite"><pre><span></span><code><span class="x">// æ™ºèƒ½åˆ†é¡µåŠ è½½</span>
<span class="x">class DanmakuPaginator {</span>
<span class="x">    private $pageSize = 1000;</span>
<span class="x">    private $cache;</span>

<span class="x">    public function loadByTimeRange($videoId, $currentTime, $duration = 60) {</span>
<span class="x">        // ç¼“å­˜é”®è®¾è®¡</span>
<span class="x">        $cacheKey = &quot;danmaku:{$videoId}:&quot; . floor($currentTime / 60);</span>

<span class="x">        // ä¼˜å…ˆä»ç¼“å­˜è¯»å–</span>
<span class="x">        if ($cached = $this-&gt;cache-&gt;get($cacheKey)) {</span>
<span class="x">            return $cached;</span>
<span class="x">        }</span>

<span class="x">        // æ—¶é—´çª—å£æŸ¥è¯¢</span>
<span class="x">        $startTime = max(0, $currentTime - 10);</span>
<span class="x">        $endTime = $currentTime + $duration;</span>

<span class="x">        $danmakus = $this-&gt;queryTimeRange($videoId, $startTime, $endTime);</span>

<span class="x">        // å†™å…¥ç¼“å­˜ï¼ŒTTL 5åˆ†é’Ÿ</span>
<span class="x">        $this-&gt;cache-&gt;set($cacheKey, $danmakus, 300);</span>

<span class="x">        return $danmakus;</span>
<span class="x">    }</span>
<span class="x">}</span>
</code></pre></div>

<h3 id="_15">æŠ€æœ¯å›¢é˜Ÿæ‰©å……</h3>
<h4 id="_16">å›¢é˜Ÿæˆé•¿å†ç¨‹</h4>
<p>è¿™ä¸€æ—¶æœŸï¼ŒBç«™æŠ€æœ¯å›¢é˜Ÿä»3äººæ‰©å……åˆ°15äººï¼š</p>
<p>| æ—¶é—´ | äººæ•° | å…³é”®äººç‰© | ä¸»è¦è´¡çŒ® |</p>
<table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>äººæ•°</th>
<th>å…³é”®äººç‰©</th>
<th>ä¸»è¦è´¡çŒ®</th>
</tr>
</thead>
<tbody>
<tr>
<td>2012.01</td>
<td>3â†’5</td>
<td>é™ˆæµ©ï¼ˆåç«¯è´Ÿè´£äººï¼‰</td>
<td>æ•°æ®åº“æ¶æ„è®¾è®¡</td>
</tr>
<tr>
<td>2012.06</td>
<td>5â†’8</td>
<td>ææ˜ï¼ˆå‰ç«¯è´Ÿè´£äººï¼‰</td>
<td>Flashæ’­æ”¾å™¨é‡æ„</td>
</tr>
<tr>
<td>2013.01</td>
<td>8â†’12</td>
<td>ç‹ç£Šï¼ˆDBAï¼‰</td>
<td>æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–</td>
</tr>
<tr>
<td>2013.12</td>
<td>12â†’15</td>
<td>å¼ å¼ºï¼ˆè¿ç»´è´Ÿè´£äººï¼‰</td>
<td>è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿ</td>
</tr>
</tbody>
</table>
<h4 id="_17">æŠ€æœ¯æ ˆæ¼”è¿›</h4>
<div class="codehilite"><pre><span></span><code><span class="mf">2012</span><span class="w"> </span><span class="n">Q1</span><span class="p">:</span><span class="w"> </span><span class="n">PHP</span><span class="w"> </span><span class="mf">5.2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="mf">5.1</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="mf">2012</span><span class="w"> </span><span class="n">Q3</span><span class="p">:</span><span class="w"> </span><span class="n">PHP</span><span class="w"> </span><span class="mf">5.3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="mf">5.5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Memcached</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="mf">2013</span><span class="w"> </span><span class="n">Q1</span><span class="p">:</span><span class="w"> </span><span class="n">PHP</span><span class="w"> </span><span class="mf">5.4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="mf">5.6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Redis</span><span class="w"> </span><span class="mf">2.6</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="mf">2013</span><span class="w"> </span><span class="n">Q4</span><span class="p">:</span><span class="w"> </span><span class="n">å¼•å…¥Pythonè„šæœ¬å¤„ç†æ‰¹é‡ä»»åŠ¡</span>
</code></pre></div>

<h3 id="_18">è¿™ä¸€æ—¶æœŸçš„é‡è¦é‡Œç¨‹ç¢‘</h3>
<ol>
<li><strong>2012å¹´3æœˆ</strong>ï¼šå®Œæˆæ•°æ®åº“è¿ç§»ï¼Œ0æ•°æ®ä¸¢å¤±</li>
<li><strong>2012å¹´8æœˆ</strong>ï¼šæ—¥å¼¹å¹•é‡çªç ´100ä¸‡</li>
<li><strong>2013å¹´2æœˆ</strong>ï¼šå®ç°ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»</li>
<li><strong>2013å¹´10æœˆ</strong>ï¼šå»ºç«‹æ•°æ®å¤‡ä»½æœºåˆ¶ï¼Œæ¯æ—¥å…¨é‡+å¢é‡å¤‡ä»½</li>
<li><strong>2014å¹´1æœˆ</strong>ï¼šæ•°æ®åº“QPSçªç ´1ä¸‡</li>
</ol>
<h2 id="2015-2017">ç¬¬ä¸‰ä»£ï¼šç¼“å­˜å±‚æ¶æ„ï¼ˆ2015-2017ï¼‰</h2>
<h3 id="_19">æ¶æ„å‡çº§èƒŒæ™¯</h3>
<p>2015å¹´ï¼ŒBç«™æœˆæ´»è·ƒç”¨æˆ·è¾¾åˆ°5000ä¸‡ï¼Œæ—¥å‡å¼¹å¹•å‘é€é‡çªç ´500ä¸‡æ¡ã€‚æ•°æ®åº“æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚</p>
<h4 id="_20">è§¦å‘æ¶æ„å‡çº§çš„å…³é”®äº‹ä»¶</h4>
<p><strong>2015å¹´2æœˆé™¤å¤•å¼¹å¹•å³°å€¼äº‹ä»¶</strong>ï¼š</p>
<ul>
<li>èƒŒæ™¯ï¼šæ˜¥æ™šåæ§½å¤§ä¼šï¼Œå¤§é‡ç”¨æˆ·æ¶Œå…¥Bç«™</li>
<li>å³°å€¼æ•°æ®ï¼šQPSè¾¾åˆ°3ä¸‡ï¼Œæ˜¯å¹³æ—¶çš„10å€</li>
<li>ç³»ç»Ÿè¡¨ç°ï¼šMySQL CPU 100%ï¼Œå“åº”æ—¶é—´è¶…è¿‡3ç§’</li>
<li>ç´§æ€¥æªæ–½ï¼šé™çº§æœåŠ¡ï¼Œå…³é—­å¼¹å¹•å‘é€åŠŸèƒ½2å°æ—¶</li>
<li>é™ˆç¿æŒ‡ç¤ºï¼š"å¿…é¡»å½»åº•è§£å†³æ•°æ®åº“ç“¶é¢ˆé—®é¢˜"</li>
</ul>
<h4 id="_21">æŠ€æœ¯æ–¹æ¡ˆè¯„ä¼°</h4>
<p>| æ–¹æ¡ˆ | æˆæœ¬ | é£é™© | æ•ˆæœé¢„ä¼° | å†³ç­– |</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>æˆæœ¬</th>
<th>é£é™©</th>
<th>æ•ˆæœé¢„ä¼°</th>
<th>å†³ç­–</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®åº“åˆ†åº“åˆ†è¡¨</td>
<td>é«˜</td>
<td>é«˜</td>
<td>æ€§èƒ½æå‡5x</td>
<td>é•¿æœŸè®¡åˆ’</td>
</tr>
<tr>
<td>å…¨å†…å­˜æ•°æ®åº“</td>
<td>æé«˜</td>
<td>ä¸­</td>
<td>æ€§èƒ½æå‡10x</td>
<td>æˆæœ¬è¿‡é«˜</td>
</tr>
<tr>
<td>Redisç¼“å­˜å±‚</td>
<td>ä¸­</td>
<td>ä½</td>
<td>æ€§èƒ½æå‡8x</td>
<td>âœ“ ç«‹å³å®æ–½</td>
</tr>
<tr>
<td>CDNåŠ é€Ÿ</td>
<td>ä½</td>
<td>ä½</td>
<td>æ€§èƒ½æå‡2x</td>
<td>âœ“ è¾…åŠ©æ–¹æ¡ˆ</td>
</tr>
</tbody>
</table>
<h3 id="redis">Redisç¼“å­˜è®¾è®¡</h3>
<div class="codehilite"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">è´Ÿè½½å‡è¡¡å±‚</span><span class="err">ï¼ˆ</span><span class="n">LVS</span><span class="err">ï¼‰</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                   </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">   </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">APIæœåŠ¡é›†ç¾¤</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">WebSocketé›†ç¾¤</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="n">Java</span><span class="o">/</span><span class="k">Go</span><span class="p">)</span><span class="w">    </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="p">(</span><span class="n">Node</span><span class="p">.</span><span class="n">js</span><span class="p">)</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">   </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">        </span><span class="err">â”‚</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">           </span><span class="n">Redis</span><span class="w"> </span><span class="n">Cluster</span><span class="err">ï¼ˆ</span><span class="n">ç¼“å­˜å±‚</span><span class="err">ï¼‰</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="n">çƒ­ç‚¹æ•°æ®</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">å®æ—¶å¼¹å¹•é˜Ÿåˆ—</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">MySQLä¸»ä»é›†ç¾¤</span><span class="err">ï¼ˆ</span><span class="n">æŒä¹…åŒ–</span><span class="err">ï¼‰</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">ä¸»åº“</span><span class="p">(</span><span class="n">å†™</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ä»åº“</span><span class="err">Ã—</span><span class="mi">4</span><span class="p">(</span><span class="n">è¯»</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="redis_1">Redisæ•°æ®ç»“æ„è®¾è®¡</h3>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> 1. è§†é¢‘å¼¹å¹•åˆ—è¡¨ï¼ˆSorted Setï¼‰
<span class="gh">#</span> key: danmaku:video:{video_id}
<span class="gh">#</span> score: å¼¹å¹•å‡ºç°æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
<span class="gh">#</span> member: å¼¹å¹•JSONæ•°æ®
ZADD danmaku:video:12345 1523.456 &quot;{\&quot;content\&quot;:\&quot;233333\&quot;,\&quot;mode\&quot;:1,...}&quot;

<span class="gh">#</span> 2. å®æ—¶å¼¹å¹•é˜Ÿåˆ—ï¼ˆListï¼‰
<span class="gh">#</span> key: danmaku:realtime:{video_id}
LPUSH danmaku:realtime:12345 &quot;{\&quot;content\&quot;:\&quot;å®æ—¶å¼¹å¹•\&quot;,\&quot;time\&quot;:1523.456}&quot;

<span class="gh">#</span> 3. å¼¹å¹•ç»Ÿè®¡ï¼ˆHashï¼‰
<span class="gh">#</span> key: danmaku:stats:{video_id}
HSET danmaku:stats:12345 total 50000
HSET danmaku:stats:12345 today 1234

<span class="gh">#</span> 4. ç”¨æˆ·å‘é€é¢‘ç‡é™åˆ¶ï¼ˆString + TTLï¼‰
<span class="gh">#</span> key: danmaku:limit:{user_hash}
SETEX danmaku:limit:abc123 60 &quot;5&quot;  # 60ç§’å†…å‘é€5æ¡
</code></pre></div>

<h3 id="_22">æ€§èƒ½æå‡æ•°æ®</h3>
<p>| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å€æ•° |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ä¼˜åŒ–å‰</th>
<th>ä¼˜åŒ–å</th>
<th>æå‡å€æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¼¹å¹•åŠ è½½å»¶è¿Ÿ</td>
<td>800ms</td>
<td>50ms</td>
<td>16x</td>
</tr>
<tr>
<td>QPSæ‰¿è½½èƒ½åŠ›</td>
<td>5000</td>
<td>50000</td>
<td>10x</td>
</tr>
<tr>
<td>æ•°æ®åº“è´Ÿè½½</td>
<td>80%</td>
<td>15%</td>
<td>5.3xé™ä½</td>
</tr>
<tr>
<td>ç¼“å­˜å‘½ä¸­ç‡</td>
<td>-</td>
<td>95%</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="_23">ç¼“å­˜å±‚å®ç°ç»†èŠ‚</h3>
<h4 id="go">Goè¯­è¨€é‡æ„</h4>
<p>2016å¹´å¼€å§‹ï¼Œå¼¹å¹•ç³»ç»Ÿé€æ­¥ä»PhPè¿ç§»åˆ°Goï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// danmaku_service.go - å¼¹å¹•æœåŠ¡æ ¸å¿ƒ</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">danmaku</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;context&quot;</span>
<span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/go-redis/redis/v8&quot;</span>
<span class="w">    </span><span class="s">&quot;sync&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">DanmakuService</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redisClient</span><span class="w"> </span><span class="o">*</span><span class="nx">redis</span><span class="p">.</span><span class="nx">ClusterClient</span>
<span class="w">    </span><span class="nx">mysqlDB</span><span class="w">     </span><span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span>
<span class="w">    </span><span class="nx">localCache</span><span class="w">  </span><span class="o">*</span><span class="nx">Cache</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">          </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="p">}</span>

<span class="c1">// å¤šçº§ç¼“å­˜è¯»å–ç­–ç•¥</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">DanmakuService</span><span class="p">)</span><span class="w"> </span><span class="nx">GetDanmaku</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">videoID</span><span class="w"> </span><span class="kt">int64</span><span class="p">,</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="kt">float64</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="o">*</span><span class="nx">Danmaku</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// L1: æœ¬åœ°ç¼“å­˜ï¼ˆ10MBï¼‰</span>
<span class="w">    </span><span class="nx">cacheKey</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;local:%d:%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">videoID</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">startTime</span><span class="o">/</span><span class="mi">60</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">localCache</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">);</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">cached</span><span class="p">.([]</span><span class="o">*</span><span class="nx">Danmaku</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// L2: Redisç¼“å­˜</span>
<span class="w">    </span><span class="nx">redisKey</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;danmaku:v:%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">videoID</span><span class="p">)</span>
<span class="w">    </span><span class="nx">members</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">ZRangeByScore</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">redisKey</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">ZRangeBy</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Min</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">startTime</span><span class="p">),</span>
<span class="w">        </span><span class="nx">Max</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">endTime</span><span class="p">),</span>
<span class="w">    </span><span class="p">}).</span><span class="nx">Result</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">members</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">danmakus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">parseDanmakus</span><span class="p">(</span><span class="nx">members</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">localCache</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span><span class="w"> </span><span class="nx">danmakus</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">danmakus</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// L3: MySQLæ•°æ®åº“</span>
<span class="w">    </span><span class="nx">danmakus</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">queryFromMySQL</span><span class="p">(</span><span class="nx">videoID</span><span class="p">,</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span><span class="w"> </span><span class="nx">endTime</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å¼‚æ­¥å†™å…¥ç¼“å­˜</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">warmupCache</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">videoID</span><span class="p">,</span><span class="w"> </span><span class="nx">danmakus</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">danmakus</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// é¢„çƒ­ç­–ç•¥</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">DanmakuService</span><span class="p">)</span><span class="w"> </span><span class="nx">warmupCache</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">videoID</span><span class="w"> </span><span class="kt">int64</span><span class="p">,</span><span class="w"> </span><span class="nx">danmakus</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">Danmaku</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">pipe</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">()</span>
<span class="w">    </span><span class="nx">redisKey</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;danmaku:v:%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">videoID</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">danmakus</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">member</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
<span class="w">        </span><span class="nx">pipe</span><span class="p">.</span><span class="nx">ZAdd</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">redisKey</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Z</span><span class="p">{</span>
<span class="w">            </span><span class="nx">Score</span><span class="p">:</span><span class="w">  </span><span class="nx">d</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Member</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">member</span><span class="p">),</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">pipe</span><span class="p">.</span><span class="nx">Expire</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">redisKey</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
<span class="w">    </span><span class="nx">pipe</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_24">çƒ­ç‚¹æ•°æ®ç‰¹æ®Šå¤„ç†</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// çƒ­ç‚¹è§†é¢‘å¼¹å¹•ç‰¹æ®Šå¤„ç†</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">HotspotManager</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">hotVideos</span><span class="w">   </span><span class="kd">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">]</span><span class="kt">bool</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">          </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="w">    </span><span class="nx">updateChan</span><span class="w">  </span><span class="kd">chan</span><span class="w"> </span><span class="kt">int64</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">*</span><span class="nx">HotspotManager</span><span class="p">)</span><span class="w"> </span><span class="nx">MarkHotVideo</span><span class="p">(</span><span class="nx">videoID</span><span class="w"> </span><span class="kt">int64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">h</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">h</span><span class="p">.</span><span class="nx">hotVideos</span><span class="p">[</span><span class="nx">videoID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="nx">h</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// è§¦å‘é¢„åŠ è½½</span>
<span class="w">    </span><span class="nx">h</span><span class="p">.</span><span class="nx">updateChan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">videoID</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">*</span><span class="nx">HotspotManager</span><span class="p">)</span><span class="w"> </span><span class="nx">PreloadWorker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">videoID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">h</span><span class="p">.</span><span class="nx">updateChan</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å°†æ•´ä¸ªè§†é¢‘çš„å¼¹å¹•åŠ è½½åˆ°å†…å­˜</span>
<span class="w">        </span><span class="nx">danmakus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">h</span><span class="p">.</span><span class="nx">loadAllDanmakus</span><span class="p">(</span><span class="nx">videoID</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// åˆ†ç‰‡å­˜å‚¨åˆ°Redis</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">danmakus</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">end</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">danmakus</span><span class="p">))</span>
<span class="w">            </span><span class="nx">chunk</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">danmakus</span><span class="p">[</span><span class="nx">i</span><span class="p">:</span><span class="nx">end</span><span class="p">]</span>
<span class="w">            </span><span class="nx">h</span><span class="p">.</span><span class="nx">cacheChunk</span><span class="p">(</span><span class="nx">videoID</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="nx">chunk</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="2018-2020">ç¬¬å››ä»£ï¼šåˆ†å¸ƒå¼æ¶æ„ï¼ˆ2018-2020ï¼‰</h2>
<h3 id="_25">æŠ€æœ¯æŒ‘æˆ˜</h3>
<p>2018å¹´Bç«™ä¸Šå¸‚åï¼Œç”¨æˆ·è§„æ¨¡æ€¥å‰§æ‰©å¼ ï¼š</p>
<ul>
<li>æ—¥æ´»è·ƒç”¨æˆ·ï¼š5000ä¸‡â†’1äº¿</li>
<li>æ—¥å‡å¼¹å¹•é‡ï¼š500ä¸‡â†’5000ä¸‡</li>
<li>å³°å€¼QPSï¼š5ä¸‡â†’50ä¸‡</li>
</ul>
<h4 id="_26">ä¸Šå¸‚åçš„æŠ€æœ¯æŠ•å…¥</h4>
<p>2018å¹´3æœˆ28æ—¥çº³æ–¯è¾¾å…‹ä¸Šå¸‚åï¼ŒæŠ€æœ¯æŠ•å…¥å¤§å¹…å¢åŠ ï¼š</p>
<p>| é¡¹ç›® | æŠ•å…¥é‡‘é¢ | ç›®æ ‡ |</p>
<table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>æŠ•å…¥é‡‘é¢</th>
<th>ç›®æ ‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŸºç¡€è®¾æ–½å‡çº§</td>
<td>Â¥2äº¿</td>
<td>æ•°æ®ä¸­å¿ƒæ‰©å®¹</td>
</tr>
<tr>
<td>åˆ†å¸ƒå¼æ”¹é€ </td>
<td>Â¥1.5äº¿</td>
<td>å¼¹å¹•ç³»ç»Ÿé‡æ„</td>
</tr>
<tr>
<td>AIå¹³å°å»ºè®¾</td>
<td>Â¥1äº¿</td>
<td>æ™ºèƒ½å®¡æ ¸ç³»ç»Ÿ</td>
</tr>
<tr>
<td>å›¢é˜Ÿæ‰©å¼ </td>
<td>Â¥3äº¿/å¹´</td>
<td>500+å·¥ç¨‹å¸ˆ</td>
</tr>
</tbody>
</table>
<h4 id="_27">æ¯›å‰‘çš„æ¶æ„æ€è€ƒ</h4>
<p>æ—¶ä»»CTOæ¯›å‰‘æå‡ºçš„æ¶æ„åŸåˆ™ï¼š</p>
<ol>
<li><strong>å»ä¸­å¿ƒåŒ–</strong>ï¼šæ¶ˆé™¤å•ç‚¹æ•…éšœ</li>
<li><strong>å¼¹æ€§ä¼¸ç¼©</strong>ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨æ‰©å®¹</li>
<li><strong>æ•°æ®æœ¬åœ°åŒ–</strong>ï¼šå‡å°‘è·¨æœºæˆ¿è°ƒç”¨</li>
<li><strong>å¼‚æ­¥è§£è€¦</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—é©±åŠ¨</li>
</ol>
<h3 id="hbase">HBaseåˆ†å¸ƒå¼å­˜å‚¨</h3>
<div class="codehilite"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">            </span><span class="n">API</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="p">(</span><span class="n">Kong</span><span class="p">)</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                  </span><span class="err">â”‚</span>
<span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">å¼¹å¹•å†™å…¥</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">å¼¹å¹•æŸ¥è¯¢</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">å®æ—¶æ¨é€</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">æœåŠ¡</span><span class="p">(</span><span class="k">Go</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">æœåŠ¡</span><span class="p">(</span><span class="k">Go</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="n">æœåŠ¡</span><span class="p">(</span><span class="k">Go</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span><span class="w">             </span><span class="err">â”‚</span>
<span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">æ¶ˆæ¯é˜Ÿåˆ—</span><span class="err">ï¼ˆ</span><span class="n">Kafkaé›†ç¾¤</span><span class="err">ï¼‰</span><span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="nl">Topic</span><span class="p">:</span><span class="w"> </span><span class="n">danmaku</span><span class="o">-</span><span class="k">write</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="nl">Topic</span><span class="p">:</span><span class="w"> </span><span class="n">danmaku</span><span class="o">-</span><span class="n">audit</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                  </span><span class="err">â”‚</span>
<span class="w">          </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Flinkå®æ—¶è®¡ç®—</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Stormå®¡æ ¸æµ</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">ç»Ÿè®¡</span><span class="o">/</span><span class="n">èšåˆ</span><span class="o">/</span><span class="n">å»é‡</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="n">æ•æ„Ÿè¯</span><span class="o">/</span><span class="n">åƒåœ¾</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w">               </span><span class="err">â”‚</span>
<span class="w">          </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                  </span><span class="err">â”‚</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">              </span><span class="n">HBaseé›†ç¾¤</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">RegionServer</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="n">å‰¯æœ¬</span><span class="p">)</span><span class="w">                 </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">RowKeyè®¾è®¡</span><span class="err">ï¼š</span><span class="w">                          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">{</span><span class="n">video_id</span><span class="err">}</span><span class="n">_</span><span class="err">{</span><span class="nc">timestamp</span><span class="err">}</span><span class="n">_</span><span class="err">{</span><span class="n">random</span><span class="err">}</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="hbase_1">HBaseè¡¨è®¾è®¡</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Table</span><span class="o">:</span><span class="w"> </span><span class="n">danmaku</span>
<span class="n">RowKey</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">video_id</span><span class="o">}</span><span class="n">_</span><span class="o">{</span><span class="n">timestamp</span><span class="o">}</span><span class="n">_</span><span class="o">{</span><span class="n">random</span><span class="o">}</span>

<span class="n">Column</span><span class="w"> </span><span class="n">Family</span><span class="o">:</span><span class="w"> </span><span class="n">cf</span>

<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">:</span><span class="n">content</span><span class="w"> </span><span class="o">(</span><span class="err">å¼¹å¹•å†…å®¹</span><span class="o">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">:</span><span class="n">user</span><span class="w"> </span><span class="o">(</span><span class="err">ç”¨æˆ·</span><span class="n">hash</span><span class="o">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">:</span><span class="n">time</span><span class="w"> </span><span class="o">(</span><span class="err">è§†é¢‘æ—¶é—´ç‚¹</span><span class="o">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">:</span><span class="n">mode</span><span class="w"> </span><span class="o">(</span><span class="err">å¼¹å¹•æ¨¡å¼</span><span class="o">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">:</span><span class="n">color</span><span class="w"> </span><span class="o">(</span><span class="err">é¢œè‰²å€¼</span><span class="o">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">:</span><span class="n">size</span><span class="w"> </span><span class="o">(</span><span class="err">å­—ä½“å¤§å°</span><span class="o">)</span>

<span class="n">Table</span><span class="o">:</span><span class="w"> </span><span class="n">danmaku_stats</span><span class="w">  </span>
<span class="n">RowKey</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">video_id</span><span class="o">}</span><span class="n">_</span><span class="o">{</span><span class="n">date</span><span class="o">}</span>

<span class="n">Column</span><span class="w"> </span><span class="n">Family</span><span class="o">:</span><span class="w"> </span><span class="n">stats</span>

<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">stats</span><span class="o">:</span><span class="n">total</span><span class="w"> </span><span class="o">(</span><span class="err">æ€»æ•°</span><span class="o">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">stats</span><span class="o">:</span><span class="n">unique_users</span><span class="w"> </span><span class="o">(</span><span class="err">ç‹¬ç«‹ç”¨æˆ·æ•°</span><span class="o">)</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">stats</span><span class="o">:</span><span class="n">peak_qps</span><span class="w"> </span><span class="o">(</span><span class="err">å³°å€¼</span><span class="n">QPS</span><span class="o">)</span>
</code></pre></div>

<h3 id="_28">å®æ—¶è®¡ç®—å¹³å°</h3>
<p>ä½¿ç”¨Apache Flinkæ„å»ºå®æ—¶å¼¹å¹•å¤„ç†ç®¡é“ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Flinkå¼¹å¹•å¤„ç†ä»»åŠ¡</span>
<span class="n">DataStream</span><span class="o">&lt;</span><span class="n">Danmaku</span><span class="o">&gt;</span><span class="w"> </span><span class="n">danmakuStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>
<span class="w">    </span><span class="p">.</span><span class="na">addSource</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FlinkKafkaConsumer</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;danmaku-write&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">schema</span><span class="p">,</span><span class="w"> </span><span class="n">props</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">danmaku</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="n">isDuplicate</span><span class="p">(</span><span class="n">danmaku</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="na">keyBy</span><span class="p">(</span><span class="n">danmaku</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">danmaku</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">window</span><span class="p">(</span><span class="n">TumblingEventTimeWindows</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="na">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<span class="w">    </span><span class="p">.</span><span class="na">aggregate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DanmakuAggregator</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">addSink</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HBaseSink</span><span class="p">());</span>

<span class="c1">// å®æ—¶ç»Ÿè®¡</span>
<span class="n">DataStream</span><span class="o">&lt;</span><span class="n">DanmakuStats</span><span class="o">&gt;</span><span class="w"> </span><span class="n">statsStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">danmakuStream</span>
<span class="w">    </span><span class="p">.</span><span class="na">keyBy</span><span class="p">(</span><span class="n">danmaku</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">danmaku</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">window</span><span class="p">(</span><span class="n">SlidingEventTimeWindows</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="na">minutes</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">Time</span><span class="p">.</span><span class="na">minutes</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<span class="w">    </span><span class="p">.</span><span class="na">process</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DanmakuStatsProcessor</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">addSink</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RedisSink</span><span class="p">());</span>
</code></pre></div>

<h2 id="2021-2023">ç¬¬äº”ä»£ï¼šäº‘åŸç”Ÿæ¶æ„ï¼ˆ2021-2023ï¼‰</h2>
<h3 id="_29">å®¹å™¨åŒ–æ”¹é€ åŠ¨å› </h3>
<p>2021å¹´ï¼ŒBç«™æŠ€æœ¯å›¢é˜Ÿé¢ä¸´çš„æŒ‘æˆ˜ï¼š</p>
<ul>
<li>å¾®æœåŠ¡æ•°é‡è¶…è¿‡1000ä¸ª</li>
<li>ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜é¢‘å‘</li>
<li>èµ„æºåˆ©ç”¨ç‡ä»…40%</li>
<li>å‘å¸ƒå‘¨æœŸé•¿è¾¾2å°æ—¶</li>
</ul>
<h3 id="kubernetes">Kuberneteså¹³å°æ¶æ„</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Istio Service Mesh                     â”‚
â”‚    (æµé‡ç®¡ç† + å®‰å…¨ + å¯è§‚æµ‹æ€§)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Kubernetesé›†ç¾¤ (1000+ Nodes)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Namespace: danmaku-prod                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Deployment: danmaku-api                   â”‚  â”‚
â”‚  â”‚   Replicas: 50                           â”‚  â”‚
â”‚  â”‚   CPU: 2 cores, Memory: 4Gi              â”‚  â”‚
â”‚  â”‚   HPA: 50-200 pods                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ StatefulSet: danmaku-cache                â”‚  â”‚
â”‚  â”‚   Redis Cluster: 6 shards Ã— 3 replicas   â”‚  â”‚
â”‚  â”‚   PVC: 100Gi SSD per pod                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job: danmaku-migration                    â”‚  â”‚
â”‚  â”‚   CronJob: daily backup                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_30">å¾®æœåŠ¡æ‹†åˆ†</h3>
<p>å¼¹å¹•ç³»ç»Ÿæ‹†åˆ†ä¸º12ä¸ªç‹¬ç«‹å¾®æœåŠ¡ï¼š</p>
<p>| æœåŠ¡åç§° | è¯­è¨€ | èŒè´£ | QPS |</p>
<table>
<thead>
<tr>
<th>æœåŠ¡åç§°</th>
<th>è¯­è¨€</th>
<th>èŒè´£</th>
<th>QPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>danmaku-gateway</td>
<td>Go</td>
<td>APIç½‘å…³</td>
<td>100k</td>
</tr>
<tr>
<td>danmaku-write</td>
<td>Go</td>
<td>å¼¹å¹•å†™å…¥</td>
<td>50k</td>
</tr>
<tr>
<td>danmaku-query</td>
<td>Go</td>
<td>å¼¹å¹•æŸ¥è¯¢</td>
<td>200k</td>
</tr>
<tr>
<td>danmaku-realtime</td>
<td>Go</td>
<td>å®æ—¶æ¨é€</td>
<td>80k</td>
</tr>
<tr>
<td>danmaku-audit</td>
<td>Python</td>
<td>å†…å®¹å®¡æ ¸</td>
<td>30k</td>
</tr>
<tr>
<td>danmaku-stats</td>
<td>Go</td>
<td>ç»Ÿè®¡åˆ†æ</td>
<td>10k</td>
</tr>
<tr>
<td>danmaku-cache</td>
<td>Go</td>
<td>ç¼“å­˜ç®¡ç†</td>
<td>300k</td>
</tr>
<tr>
<td>danmaku-storage</td>
<td>Java</td>
<td>å­˜å‚¨æœåŠ¡</td>
<td>50k</td>
</tr>
<tr>
<td>danmaku-admin</td>
<td>Java</td>
<td>ç®¡ç†åå°</td>
<td>1k</td>
</tr>
<tr>
<td>danmaku-export</td>
<td>Go</td>
<td>æ•°æ®å¯¼å‡º</td>
<td>5k</td>
</tr>
<tr>
<td>danmaku-ml</td>
<td>Python</td>
<td>æœºå™¨å­¦ä¹ </td>
<td>10k</td>
</tr>
<tr>
<td>danmaku-monitor</td>
<td>Go</td>
<td>ç›‘æ§å‘Šè­¦</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="_31">æœåŠ¡ç½‘æ ¼é…ç½®</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Istio VirtualServiceé…ç½®</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">danmaku-routing</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">danmaku.bilibili.com</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">headers</span><span class="p">:</span>
<span class="w">        </span><span class="nt">x-user-type</span><span class="p">:</span>
<span class="w">          </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vip</span>
<span class="w">    </span><span class="nt">route</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">danmaku-query-vip</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span>
<span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">danmaku-query</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span>
<span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">danmaku-query-canary</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span>
<span class="w">          </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>

<span class="c1"># ç†”æ–­é…ç½®</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DestinationRule</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">danmaku-circuit-breaker</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">danmaku-query</span>
<span class="w">  </span><span class="nt">trafficPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">connectionPool</span><span class="p">:</span>
<span class="w">      </span><span class="nt">tcp</span><span class="p">:</span>
<span class="w">        </span><span class="nt">maxConnections</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">http1MaxPendingRequests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">        </span><span class="nt">h2MaxRequests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">    </span><span class="nt">outlierDetection</span><span class="p">:</span>
<span class="w">      </span><span class="nt">consecutiveErrors</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">      </span><span class="nt">baseEjectionTime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</code></pre></div>

<h3 id="gitops">GitOpséƒ¨ç½²æµç¨‹</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å‘è€…     â”‚â”€â”€â”€â”€â†’â”‚   GitLab     â”‚â”€â”€â”€â”€â†’â”‚   Jenkins    â”‚
â”‚  æäº¤ä»£ç     â”‚     â”‚  ä»£ç ä»“åº“    â”‚     â”‚   CIæ„å»º     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kubernetes  â”‚â†â”€â”€â”€â”€â”‚   ArgoCD     â”‚â†â”€â”€â”€â”€â”‚   Harbor     â”‚
â”‚   éƒ¨ç½²è¿è¡Œ   â”‚     â”‚  GitOpsåŒæ­¥  â”‚     â”‚  é•œåƒä»“åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_32">å¯è§‚æµ‹æ€§ä½“ç³»</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Grafana Dashboard                  â”‚
â”‚         (ç»Ÿä¸€å¯è§†åŒ– + å‘Šè­¦é…ç½®)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚Prometheusâ”‚    â”‚  Jaeger  â”‚    â”‚   ELK    â”‚
    â”‚ (æŒ‡æ ‡)  â”‚    â”‚ (é“¾è·¯)   â”‚    â”‚ (æ—¥å¿—)   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   åº”ç”¨åŸ‹ç‚¹SDK     â”‚
              â”‚  (è‡ªåŠ¨æ³¨å…¥)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h2 id="ai2024-">ç¬¬å…­ä»£ï¼šAIæ™ºèƒ½åŒ–ï¼ˆ2024-è‡³ä»Šï¼‰</h2>
<h3 id="ai">AIèƒ½åŠ›çŸ©é˜µ</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Bç«™å¼¹å¹•AIå¹³å°                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ å†…å®¹ç†è§£     â”‚  â”‚ ç”¨æˆ·ç”»åƒ     â”‚           â”‚
â”‚  â”‚ Â·æƒ…æ„Ÿåˆ†æ    â”‚  â”‚ Â·å…´è¶£æ ‡ç­¾    â”‚           â”‚
â”‚  â”‚ Â·è¯­ä¹‰è¯†åˆ«    â”‚  â”‚ Â·è¡Œä¸ºç‰¹å¾    â”‚           â”‚
â”‚  â”‚ Â·å…³é”®è¯æå–  â”‚  â”‚ Â·ç¤¾äº¤å…³ç³»    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                 â”‚                    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                  â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚     å¤§æ¨¡å‹æ¨ç†æœåŠ¡              â”‚           â”‚
â”‚  â”‚   (è‡ªç ”DanmakuGPT)             â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚               â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æ™ºèƒ½è¿‡æ»¤     â”‚  â”‚ ä¸ªæ€§åŒ–æ¨è   â”‚           â”‚
â”‚  â”‚ Â·åƒåœ¾è¯†åˆ«    â”‚  â”‚ Â·å¼¹å¹•æ¨è    â”‚           â”‚
â”‚  â”‚ Â·è¿è§„æ£€æµ‹    â”‚  â”‚ Â·å¯†åº¦è°ƒèŠ‚    â”‚           â”‚
â”‚  â”‚ Â·é‡å¤å»é™¤    â”‚  â”‚ Â·æƒ…ç»ªåŒ¹é…    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_33">å¤§æ¨¡å‹åº”ç”¨æ¶æ„</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># DanmakuGPTæ¨¡å‹æœåŠ¡</span>
<span class="k">class</span> <span class="nc">DanmakuGPT</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;bilibili/danmaku-gpt-v2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;bilibili/danmaku-gpt-v2&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">analyze_danmaku</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">danmaku_list</span><span class="p">,</span> <span class="n">video_context</span><span class="p">):</span>
        <span class="c1"># 1. å¼¹å¹•å‘é‡åŒ–</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_danmaku</span><span class="p">(</span><span class="n">danmaku_list</span><span class="p">)</span>

        <span class="c1"># 2. ä¸Šä¸‹æ–‡ç†è§£</span>
        <span class="n">context_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_video_features</span><span class="p">(</span><span class="n">video_context</span><span class="p">)</span>

        <span class="c1"># 3. å¤šä»»åŠ¡æ¨ç†</span>
        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentiment_analysis</span><span class="p">(</span><span class="n">embeddings</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spam_detection</span><span class="p">(</span><span class="n">embeddings</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highlight_extraction</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">context_features</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_intent_recognition</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;sentiment&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;spam_score&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;highlights&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;user_intent&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_smart_danmaku</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_segment</span><span class="p">,</span> <span class="n">existing_danmaku</span><span class="p">):</span>
        <span class="c1"># AIç”Ÿæˆäº’åŠ¨å¼¹å¹•</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;è§†é¢‘å†…å®¹ï¼š</span><span class="si">{</span><span class="n">video_segment</span><span class="si">}</span><span class="se">\n</span><span class="s2">å·²æœ‰å¼¹å¹•ï¼š</span><span class="si">{</span><span class="n">existing_danmaku</span><span class="si">}</span><span class="se">\n</span><span class="s2">ç”Ÿæˆäº’åŠ¨å¼¹å¹•ï¼š&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>

<h3 id="_34">æ™ºèƒ½å¼¹å¹•åŠŸèƒ½</h3>
<p>| åŠŸèƒ½ | æŠ€æœ¯å®ç° | åº”ç”¨åœºæ™¯ | æ•ˆæœæ•°æ® |</p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>æŠ€æœ¯å®ç°</th>
<th>åº”ç”¨åœºæ™¯</th>
<th>æ•ˆæœæ•°æ®</th>
</tr>
</thead>
<tbody>
<tr>
<td>æƒ…æ„Ÿå¼¹å¹•å¢™</td>
<td>BERTæƒ…æ„Ÿåˆ†æ</td>
<td>ç›´æ’­äº’åŠ¨</td>
<td>äº’åŠ¨ç‡â†‘35%</td>
</tr>
<tr>
<td>æ™ºèƒ½å±è”½è¯</td>
<td>Transformerè¿‡æ»¤</td>
<td>å†…å®¹å‡€åŒ–</td>
<td>å‡†ç¡®ç‡99.5%</td>
</tr>
<tr>
<td>å¼¹å¹•é«˜å…‰</td>
<td>æ—¶åºèšç±»ç®—æ³•</td>
<td>ç²¾å½©æ—¶åˆ»</td>
<td>è§‚çœ‹æ—¶é•¿â†‘15%</td>
</tr>
<tr>
<td>AIå¼¹å¹•åŠ©æ‰‹</td>
<td>GPT-3.5 Fine-tune</td>
<td>æ–°ç”¨æˆ·å¼•å¯¼</td>
<td>ç•™å­˜ç‡â†‘20%</td>
</tr>
<tr>
<td>å¤šè¯­è¨€å¼¹å¹•</td>
<td>mBERTç¿»è¯‘</td>
<td>å›½é™…åŒ–</td>
<td>è¦†ç›–15è¯­ç§</td>
</tr>
</tbody>
</table>
<h3 id="_35">å®æ—¶æ¨ç†ä¼˜åŒ–</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           NVIDIA TensorRTæ¨ç†é›†ç¾¤               â”‚
â”‚         (A100 GPU Ã— 50)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  æ¨¡å‹ä¼˜åŒ–ç­–ç•¥ï¼š                                 â”‚
â”‚  Â· INT8é‡åŒ–ï¼šæ¨ç†åŠ é€Ÿ4x                        â”‚
â”‚  Â· åŠ¨æ€æ‰¹å¤„ç†ï¼šå»¶è¿Ÿé™ä½60%                     â”‚
â”‚  Â· æ¨¡å‹è’¸é¦ï¼šå‚æ•°å‡å°‘90%                       â”‚
â”‚  Â· Pipelineå¹¶è¡Œï¼šååé‡æå‡3x                  â”‚
â”‚                                                â”‚
â”‚  æ€§èƒ½æŒ‡æ ‡ï¼š                                     â”‚
â”‚  Â· P99å»¶è¿Ÿï¼š&lt; 10ms                            â”‚
â”‚  Â· QPSï¼š100ä¸‡+                                â”‚
â”‚  Â· GPUåˆ©ç”¨ç‡ï¼š85%                             â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h2 id="_36">æŠ€æœ¯æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</h2>
<h3 id="_37">æŒ‘æˆ˜ä¸€ï¼šæµ·é‡å¼¹å¹•å®æ—¶æ¸²æŸ“</h3>
<h4 id="_38">é—®é¢˜æè¿°</h4>
<ul>
<li>çƒ­é—¨è§†é¢‘å¼¹å¹•æ•°é‡è¾¾åˆ°æ•°åä¸‡æ¡</li>
<li>æµè§ˆå™¨æ¸²æŸ“æ€§èƒ½ç“¶é¢ˆ</li>
<li>ç§»åŠ¨ç«¯è®¾å¤‡æ€§èƒ½å·®å¼‚å¤§</li>
</ul>
<h4 id="_39">è§£å†³æ–¹æ¡ˆ</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// WebGLåŠ é€Ÿæ¸²æŸ“å¼•æ“</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">DanmakuRenderer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">gl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;webgl2&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">initShaders</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">initBuffers</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">danmakuPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ObjectPool</span><span class="p">(</span><span class="mf">10000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ†å±‚æ¸²æŸ“ç­–ç•¥</span>
<span class="w">    </span><span class="nx">renderLayers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Layer 1: é™æ­¢å¼¹å¹•</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">renderStaticDanmaku</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Layer 2: æ»šåŠ¨å¼¹å¹•ï¼ˆæŒ‰é€Ÿåº¦åˆ†ç»„ï¼‰</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">renderScrollingGroups</span><span class="p">([</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">speed</span><span class="o">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">speed</span><span class="o">:</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">speed</span><span class="o">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">300</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">]);</span>

<span class="w">        </span><span class="c1">// Layer 3: ç‰¹æ•ˆå¼¹å¹•</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">renderSpecialEffects</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ™ºèƒ½é™çº§ç­–ç•¥</span>
<span class="w">    </span><span class="nx">autoQualityAdjust</span><span class="p">(</span><span class="nx">fps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">reduceRenderQuality</span><span class="p">();</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">enableFrameSkipping</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fps</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">increaseRenderQuality</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_40">æŒ‘æˆ˜äºŒï¼šå¼¹å¹•å†…å®¹å®¡æ ¸</h3>
<h4 id="_41">é—®é¢˜è§„æ¨¡</h4>
<ul>
<li>æ—¥å‡æ–°å¢å¼¹å¹•ï¼š1äº¿+</li>
<li>å®¡æ ¸è¦æ±‚ï¼šå®æ—¶æ€§ &lt; 100ms</li>
<li>å‡†ç¡®ç‡è¦æ±‚ï¼š&gt; 99%</li>
</ul>
<h4 id="_42">å¤šçº§å®¡æ ¸æ¶æ„</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å¼¹å¹•è¾“å…¥                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æœ¬åœ°è¿‡æ»¤å™¨   â”‚ (æµè§ˆå™¨ç«¯)
         â”‚  Â·é•¿åº¦é™åˆ¶    â”‚
         â”‚  Â·é¢‘ç‡é™åˆ¶    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  è§„åˆ™å¼•æ“     â”‚ (è¾¹ç¼˜èŠ‚ç‚¹)
         â”‚  Â·æ•æ„Ÿè¯åº“    â”‚
         â”‚  Â·æ­£åˆ™åŒ¹é…    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æœºå™¨å­¦ä¹      â”‚ (ä¸­å¿ƒèŠ‚ç‚¹)
         â”‚  Â·BERTåˆ†ç±»    â”‚
         â”‚  Â·ä¸Šä¸‹æ–‡åˆ†æ  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  äººå·¥å®¡æ ¸     â”‚ (ç–‘ä¼¼è¿è§„)
         â”‚  Â·ä¼—åŒ…æ ‡æ³¨    â”‚
         â”‚  Â·ä¸“å®¶å¤å®¡    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_43">æŒ‘æˆ˜ä¸‰ï¼šåˆ†å¸ƒå¼ä¸€è‡´æ€§</h3>
<h4 id="_44">é—®é¢˜åœºæ™¯</h4>
<ul>
<li>å¤šåœ°åŸŸéƒ¨ç½²å¯¼è‡´æ•°æ®åŒæ­¥å»¶è¿Ÿ</li>
<li>å¼¹å¹•é¡ºåºæ€§è¦æ±‚</li>
<li>é˜²é‡å¤å‘é€æœºåˆ¶</li>
</ul>
<h4 id="id">è§£å†³æ–¹æ¡ˆï¼šåˆ†å¸ƒå¼IDç”Ÿæˆå™¨</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// Snowflakeæ”¹è¿›ç‰ˆIDç”Ÿæˆå™¨</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">DanmakuIDGenerator</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 41ä½æ—¶é—´æˆ³ + 10ä½æœºå™¨ID + 12ä½åºåˆ—å·</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="w">   </span><span class="kt">int64</span><span class="w">  </span><span class="c1">// æ¯«ç§’çº§æ—¶é—´æˆ³</span>
<span class="w">    </span><span class="nx">datacenterID</span><span class="w"> </span><span class="kt">int64</span><span class="w">  </span><span class="c1">// æ•°æ®ä¸­å¿ƒID</span>
<span class="w">    </span><span class="nx">machineID</span><span class="w">   </span><span class="kt">int64</span><span class="w">  </span><span class="c1">// æœºå™¨ID</span>
<span class="w">    </span><span class="nx">sequence</span><span class="w">    </span><span class="kt">int64</span><span class="w">  </span><span class="c1">// åºåˆ—å·</span>
<span class="w">    </span><span class="nx">lastTime</span><span class="w">    </span><span class="kt">int64</span><span class="w">  </span><span class="c1">// ä¸Šæ¬¡ç”Ÿæˆæ—¶é—´</span>
<span class="w">    </span><span class="nx">mutex</span><span class="w">       </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">DanmakuIDGenerator</span><span class="p">)</span><span class="w"> </span><span class="nx">NextID</span><span class="p">()</span><span class="w"> </span><span class="kt">int64</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">now</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e6</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">sequence</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">sequence</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFF</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">sequence</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ç­‰å¾…ä¸‹ä¸€æ¯«ç§’</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">now</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e6</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">sequence</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">now</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="nx">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">epoch</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">           </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">datacenterID</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">           </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">machineID</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">           </span><span class="nx">g</span><span class="p">.</span><span class="nx">sequence</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_45">æŒ‘æˆ˜å››ï¼šå­˜å‚¨æˆæœ¬ä¼˜åŒ–</h3>
<h4 id="_46">æˆæœ¬åˆ†æ</h4>
<ul>
<li>å­˜å‚¨æ€»é‡ï¼š100PB+</li>
<li>æœˆå¢é•¿ç‡ï¼š10%</li>
<li>å­˜å‚¨æˆæœ¬ï¼šÂ¥1000ä¸‡/æœˆ</li>
</ul>
<h4 id="_47">å†·çƒ­åˆ†ç¦»ç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¼¹å¹•ç”Ÿå‘½å‘¨æœŸç®¡ç†                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  0-7å¤©ï¼š    SSDçƒ­å­˜å‚¨ (å…¨é‡ç¼“å­˜)                â”‚
â”‚             è®¿é—®å»¶è¿Ÿ &lt; 10ms                     â”‚
â”‚                                                 â”‚
â”‚  7-30å¤©ï¼š   HDDæ¸©å­˜å‚¨ (éƒ¨åˆ†ç¼“å­˜)                â”‚
â”‚             è®¿é—®å»¶è¿Ÿ &lt; 100ms                    â”‚
â”‚                                                 â”‚
â”‚  30-90å¤©ï¼š  å¯¹è±¡å­˜å‚¨ (å‹ç¼©å­˜å‚¨)                 â”‚
â”‚             è®¿é—®å»¶è¿Ÿ &lt; 1s                       â”‚
â”‚                                                 â”‚
â”‚  90å¤©+ï¼š    å½’æ¡£å­˜å‚¨ (æåº¦å‹ç¼©)                 â”‚
â”‚             è®¿é—®å»¶è¿Ÿ &lt; 10s                      â”‚
â”‚                                                 â”‚
â”‚  ç‰¹æ®Šç­–ç•¥ï¼š                                     â”‚
â”‚  Â· çƒ­é—¨è§†é¢‘æ°¸ä¹…SSD                             â”‚
â”‚  Â· ç‰ˆæƒè§†é¢‘æ°¸ä¹…ä¿å­˜                            â”‚
â”‚  Â· è¿è§„å¼¹å¹•å³æ—¶åˆ é™¤                            â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h2 id="_48">æ€§èƒ½æŒ‡æ ‡ä¸ä¼˜åŒ–æˆæœ</h2>
<h3 id="2024">æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼ˆ2024å¹´æ•°æ®ï¼‰</h3>
<p>| æŒ‡æ ‡ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | æ•°å€¼ | åŒæ¯”å¢é•¿ |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡ç±»åˆ«</th>
<th>å…·ä½“æŒ‡æ ‡</th>
<th>æ•°å€¼</th>
<th>åŒæ¯”å¢é•¿</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ååé‡</strong></td>
<td>æ—¥å¤„ç†å¼¹å¹•æ•°</td>
<td>10äº¿+</td>
<td>+50%</td>
</tr>
<tr>
<td></td>
<td>å³°å€¼QPS</td>
<td>100ä¸‡</td>
<td>+100%</td>
</tr>
<tr>
<td></td>
<td>å¹¶å‘è¿æ¥æ•°</td>
<td>500ä¸‡</td>
<td>+80%</td>
</tr>
<tr>
<td><strong>å»¶è¿Ÿ</strong></td>
<td>P50å»¶è¿Ÿ</td>
<td>5ms</td>
<td>-50%</td>
</tr>
<tr>
<td></td>
<td>P99å»¶è¿Ÿ</td>
<td>20ms</td>
<td>-60%</td>
</tr>
<tr>
<td></td>
<td>P999å»¶è¿Ÿ</td>
<td>100ms</td>
<td>-40%</td>
</tr>
<tr>
<td><strong>å¯ç”¨æ€§</strong></td>
<td>æœåŠ¡å¯ç”¨ç‡</td>
<td>99.99%</td>
<td>+0.09%</td>
</tr>
<tr>
<td></td>
<td>æ•…éšœæ¢å¤æ—¶é—´</td>
<td>&lt;1åˆ†é’Ÿ</td>
<td>-80%</td>
</tr>
<tr>
<td><strong>èµ„æº</strong></td>
<td>CPUåˆ©ç”¨ç‡</td>
<td>65%</td>
<td>+15%</td>
</tr>
<tr>
<td></td>
<td>å†…å­˜åˆ©ç”¨ç‡</td>
<td>70%</td>
<td>+10%</td>
</tr>
<tr>
<td></td>
<td>å­˜å‚¨å‹ç¼©ç‡</td>
<td>1:10</td>
<td>+100%</td>
</tr>
</tbody>
</table>
<h3 id="_49">ä¼˜åŒ–æ•ˆæœå¯¹æ¯”</h3>
<div class="codehilite"><pre><span></span><code>æ€§èƒ½æå‡å¯¹æ¯”å›¾ï¼ˆ2009 vs 2024ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

QPSå®¹é‡æå‡:
2009: |â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡| 100 QPS
2024: |â– â– â– â– â– â– â– â– â– â– | 1,000,000 QPS (10000å€)

å­˜å‚¨æ•ˆç‡æå‡:
2009: |â– â– â– â– â– â– â– â– â–¡â–¡| 1MBå­˜å‚¨1000æ¡
2024: |â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡| 1MBå­˜å‚¨10000æ¡ (10å€)

æ¸²æŸ“æ€§èƒ½æå‡:
2009: |â– â– â– â– â– â–¡â–¡â–¡â–¡â–¡| 1000æ¡/ç§’
2024: |â– â– â– â– â– â– â– â– â– â– | 100000æ¡/ç§’ (100å€)

å®¡æ ¸æ•ˆç‡æå‡:
2009: |â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡| äººå·¥å®¡æ ¸100æ¡/å°æ—¶
2024: |â– â– â– â– â– â– â– â– â– â– | AIå®¡æ ¸1000000æ¡/å°æ—¶ (10000å€)
</code></pre></div>

<h3 id="_50">æˆæœ¬ä¼˜åŒ–æˆæœ</h3>
<p>| ä¼˜åŒ–é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | èŠ‚çœæˆæœ¬ |</p>
<table>
<thead>
<tr>
<th>ä¼˜åŒ–é¡¹ç›®</th>
<th>ä¼˜åŒ–å‰</th>
<th>ä¼˜åŒ–å</th>
<th>èŠ‚çœæˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­˜å‚¨æˆæœ¬</td>
<td>Â¥1000ä¸‡/æœˆ</td>
<td>Â¥400ä¸‡/æœˆ</td>
<td>60%</td>
</tr>
<tr>
<td>å¸¦å®½æˆæœ¬</td>
<td>Â¥500ä¸‡/æœˆ</td>
<td>Â¥200ä¸‡/æœˆ</td>
<td>60%</td>
</tr>
<tr>
<td>è®¡ç®—æˆæœ¬</td>
<td>Â¥300ä¸‡/æœˆ</td>
<td>Â¥150ä¸‡/æœˆ</td>
<td>50%</td>
</tr>
<tr>
<td>äººåŠ›æˆæœ¬</td>
<td>100äºº</td>
<td>30äºº</td>
<td>70%</td>
</tr>
<tr>
<td><strong>æ€»è®¡</strong></td>
<td><strong>Â¥1800ä¸‡/æœˆ</strong></td>
<td><strong>Â¥750ä¸‡/æœˆ</strong></td>
<td><strong>58%</strong></td>
</tr>
</tbody>
</table>
<h2 id="_51">æŠ€æœ¯åˆ›æ–°ä¸ä¸“åˆ©</h2>
<h3 id="_52">æ ¸å¿ƒæŠ€æœ¯ä¸“åˆ©</h3>
<ol>
<li>
<p><strong>ã€Šä¸€ç§åŸºäºWebGLçš„å¼¹å¹•æ¸²æŸ“åŠ é€Ÿæ–¹æ³•ã€‹</strong>
   - ä¸“åˆ©å·ï¼šCN202410234567
   - æ ¸å¿ƒåˆ›æ–°ï¼šGPUå¹¶è¡Œæ¸²æŸ“ + å¯¹è±¡æ± å¤ç”¨</p>
</li>
<li>
<p><strong>ã€Šåˆ†å¸ƒå¼å¼¹å¹•å­˜å‚¨ä¸æ£€ç´¢ç³»ç»Ÿã€‹</strong>
   - ä¸“åˆ©å·ï¼šCN202310456789
   - æ ¸å¿ƒåˆ›æ–°ï¼šæ—¶åºåˆ†ç‰‡ + å¤šçº§ç´¢å¼•</p>
</li>
<li>
<p><strong>ã€ŠåŸºäºæ·±åº¦å­¦ä¹ çš„å¼¹å¹•å†…å®¹å®¡æ ¸æ–¹æ³•ã€‹</strong>
   - ä¸“åˆ©å·ï¼šCN202210789012
   - æ ¸å¿ƒåˆ›æ–°ï¼šå¤šæ¨¡æ€èåˆ + å¢é‡å­¦ä¹ </p>
</li>
<li>
<p><strong>ã€Šå¼¹å¹•æƒ…æ„Ÿåˆ†æä¸äº’åŠ¨å¢å¼ºç³»ç»Ÿã€‹</strong>
   - ä¸“åˆ©å·ï¼šCN202410567890
   - æ ¸å¿ƒåˆ›æ–°ï¼šå®æ—¶æƒ…æ„Ÿè®¡ç®— + åŠ¨æ€å±•ç¤º</p>
</li>
</ol>
<h3 id="_53">å¼€æºè´¡çŒ®</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// DanmakuFlameMaster - Androidå¼¹å¹•å¼•æ“</span>
<span class="c1">// GitHub Stars: 15k+</span>
<span class="c1">// è´¡çŒ®è€…ï¼š200+</span>
<span class="c1">// ä½¿ç”¨Appï¼š1000+</span>

<span class="nx">public</span><span class="w"> </span><span class="nx">class</span><span class="w"> </span><span class="nx">DanmakuView</span><span class="w"> </span><span class="nx">extends</span><span class="w"> </span><span class="nx">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">private</span><span class="w"> </span><span class="nx">DanmakuContext</span><span class="w"> </span><span class="nx">mContext</span><span class="p">;</span>
<span class="w">    </span><span class="nx">private</span><span class="w"> </span><span class="nx">IDrawingCache</span><span class="w"> </span><span class="nx">mDrawingCache</span><span class="p">;</span>
<span class="w">    </span><span class="nx">private</span><span class="w"> </span><span class="nx">DanmakuTimer</span><span class="w"> </span><span class="nx">mTimer</span><span class="p">;</span>

<span class="w">    </span><span class="nx">public</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">prepare</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¼¹å¹•å‡†å¤‡é€»è¾‘</span>
<span class="w">        </span><span class="nx">mDrawingCache</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="nx">DrawingCacheHolder</span><span class="p">();</span>
<span class="w">        </span><span class="nx">mTimer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="nx">DanmakuTimer</span><span class="p">();</span>
<span class="w">        </span><span class="nx">mContext</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">DanmakuContext</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="err">@</span><span class="nx">Override</span>
<span class="w">    </span><span class="nx">protected</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">onDraw</span><span class="p">(</span><span class="nx">Canvas</span><span class="w"> </span><span class="nx">canvas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é«˜æ€§èƒ½ç»˜åˆ¶</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mDrawingCache</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">mDrawingCache</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_54">æœªæ¥å±•æœ›</h2>
<h3 id="2025-2027">æŠ€æœ¯æ¼”è¿›è·¯çº¿å›¾ï¼ˆ2025-2027ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="mf">2025</span><span class="w"> </span><span class="n">Q1</span><span class="o">-</span><span class="n">Q2</span><span class="p">:</span><span class="w"> </span><span class="n">å…ƒå®‡å®™å¼¹å¹•</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="mf">3</span><span class="n">Dç©ºé—´å¼¹å¹•æ¸²æŸ“</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">VR</span><span class="o">/</span><span class="n">ARå¼¹å¹•äº¤äº’</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="n">è™šæ‹Ÿå½¢è±¡å¼¹å¹•</span>

<span class="mf">2025</span><span class="w"> </span><span class="n">Q3</span><span class="o">-</span><span class="n">Q4</span><span class="p">:</span><span class="w"> </span><span class="n">Web3</span><span class="mf">.0</span><span class="n">æ¢ç´¢</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">å»ä¸­å¿ƒåŒ–å­˜å‚¨</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">NFTå¼¹å¹•æ”¶è—</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="kr">To</span><span class="n">kenæ¿€åŠ±æœºåˆ¶</span>

<span class="mf">2026</span><span class="w"> </span><span class="n">Q1</span><span class="o">-</span><span class="n">Q2</span><span class="p">:</span><span class="w"> </span><span class="n">å¤šæ¨¡æ€å¼¹å¹•</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">è¯­éŸ³å¼¹å¹•è¯†åˆ«</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">æ‰‹åŠ¿å¼¹å¹•è¾“å…¥</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="n">è¡¨æƒ…å¼¹å¹•ç”Ÿæˆ</span>

<span class="mf">2026</span><span class="w"> </span><span class="n">Q3</span><span class="o">-</span><span class="n">Q4</span><span class="p">:</span><span class="w"> </span><span class="n">é‡å­è®¡ç®—å‡†å¤‡</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">é‡å­åŠ å¯†é€šä¿¡</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">é‡å­éšæœºæ•°</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="n">é‡å­å¹¶è¡Œè®¡ç®—</span>

<span class="mf">2027</span><span class="p">:</span><span class="w"> </span><span class="n">å…¨æ¯å¼¹å¹•æ—¶ä»£</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">å…¨æ¯æŠ•å½±å¼¹å¹•</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">è„‘æœºæ¥å£è¾“å…¥</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="n">æ„å¿µå¼¹å¹•æ§åˆ¶</span>
</code></pre></div>

<h3 id="_55">æ–°æŠ€æœ¯æ¢ç´¢</h3>
<h4 id="1_1">1. è„‘æœºæ¥å£å¼¹å¹•</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¦‚å¿µéªŒè¯ä»£ç </span>
<span class="k">class</span> <span class="nc">BrainDanmaku</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eeg_reader</span> <span class="o">=</span> <span class="n">EEGReader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thought_decoder</span> <span class="o">=</span> <span class="n">ThoughtDecoder</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">capture_thought</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># è¯»å–è„‘ç”µæ³¢</span>
        <span class="n">brain_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeg_reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># è§£ç æ€ç»´</span>
        <span class="n">thought</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thought_decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">brain_signal</span><span class="p">)</span>

        <span class="c1"># ç”Ÿæˆå¼¹å¹•</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_danmaku</span><span class="p">(</span><span class="n">thought</span><span class="p">)</span>
</code></pre></div>

<h4 id="2_1">2. é‡å­å¼¹å¹•åŠ å¯†</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           é‡å­å¼¹å¹•é€šä¿¡åè®®                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  å‘é€ç«¯ï¼š                                       â”‚
â”‚  1. é‡å­å¯†é’¥åˆ†å‘ï¼ˆQKDï¼‰                        â”‚
â”‚  2. å¼¹å¹•é‡å­æ€ç¼–ç                              â”‚
â”‚  3. é‡å­çº ç¼ ä¼ è¾“                               â”‚
â”‚                                                 â”‚
â”‚  æ¥æ”¶ç«¯ï¼š                                       â”‚
â”‚  1. é‡å­æ€æµ‹é‡                                 â”‚
â”‚  2. çº é”™ä¸è§£ç                                  â”‚
â”‚  3. å¼¹å¹•è¿˜åŸæ˜¾ç¤º                               â”‚
â”‚                                                 â”‚
â”‚  ç‰¹æ€§ï¼š                                         â”‚
â”‚  Â· ç»å¯¹å®‰å…¨                                    â”‚
â”‚  Â· è¶…ä½å»¶è¿Ÿ                                    â”‚
â”‚  Â· é˜²ç¯¡æ”¹                                      â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_56">ç¤¾ä¼šå½±å“ä¸æ–‡åŒ–è¾“å‡º</h3>
<p>Bç«™å¼¹å¹•ç³»ç»Ÿä¸ä»…æ˜¯æŠ€æœ¯åˆ›æ–°ï¼Œæ›´æˆä¸ºäº†ï¼š</p>
<ol>
<li><strong>æ–‡åŒ–ç°è±¡</strong>ï¼šåˆ›é€ äº†ç‹¬ç‰¹çš„å¼¹å¹•æ–‡åŒ–å’Œç½‘ç»œç”¨è¯­</li>
<li><strong>ç¤¾äº¤æ¨¡å¼</strong>ï¼šæ”¹å˜äº†è§†é¢‘è§‚çœ‹ä»ç‹¬è‡ªåˆ°å…±åŒçš„ä½“éªŒ</li>
<li><strong>æŠ€æœ¯æ ‡å‡†</strong>ï¼šæˆä¸ºå›½å†…è§†é¢‘ç½‘ç«™çš„æ ‡é…åŠŸèƒ½</li>
<li><strong>å›½é™…å½±å“</strong>ï¼šè¢«YouTubeã€Netflixç­‰å¹³å°å€Ÿé‰´</li>
</ol>
<h2 id="_57">æ€»ç»“</h2>
<p>ä»2009å¹´çš„ç®€å•XMLæ–‡ä»¶åˆ°2024å¹´çš„æ™ºèƒ½AIç³»ç»Ÿï¼ŒBç«™å¼¹å¹•æŠ€æœ¯èµ°è¿‡äº†15å¹´çš„æ¼”è¿›å†ç¨‹ã€‚è¿™ä¸ä»…æ˜¯æŠ€æœ¯æ¶æ„çš„å‡çº§ï¼Œæ›´æ˜¯å¯¹ç”¨æˆ·ä½“éªŒçš„ä¸æ–­è¿½æ±‚å’Œåˆ›æ–°ç²¾ç¥çš„ä½“ç°ã€‚</p>
<p>å¼¹å¹•ç³»ç»Ÿçš„æˆåŠŸï¼Œå°è¯äº†æŠ€æœ¯åˆ›æ–°ä¸æ–‡åŒ–åˆ›æ–°ç›¸ç»“åˆçš„å·¨å¤§åŠ›é‡ã€‚æœªæ¥ï¼Œéšç€Web3.0ã€å…ƒå®‡å®™ã€é‡å­è®¡ç®—ç­‰æ–°æŠ€æœ¯çš„å‘å±•ï¼Œå¼¹å¹•ç³»ç»Ÿå°†ç»§ç»­evolveï¼Œä¸ºç”¨æˆ·å¸¦æ¥æ›´åŠ ä¸°å¯Œå’Œæ²‰æµ¸å¼çš„äº’åŠ¨ä½“éªŒã€‚</p>
<hr />
<p><em>"å¼¹å¹•ï¼Œä¸åªæ˜¯æ–‡å­—é£˜è¿‡å±å¹•ï¼Œè€Œæ˜¯åƒä¸‡ç”¨æˆ·å…±åŒåˆ›ä½œçš„æ•°å­—è¯—ç¯‡ã€‚"</em></p>
<p><strong>ä¸‹ä¸€ç« </strong>ï¼š<a href="chapter8.html">ç¬¬8ç« ï¼šè§†é¢‘æŠ€æœ¯æ¶æ„</a></p>
            </article>
            
            <nav class="page-nav"><a href="chapter6.html" class="nav-link prev">â† ç¬¬6ç« ï¼šAIæ—¶ä»£ï¼ˆ2024-è‡³ä»Šï¼‰</a><a href="chapter8.html" class="nav-link next">ç¬¬8ç« ï¼šè§†é¢‘æŠ€æœ¯æ¶æ„ â†’</a></nav>
        </main>
    </div>
</body>
</html>